<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار شامل للمشاكل</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { padding: 8px; width: 300px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .test-results { margin-top: 20px; }
        .test-item { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>اختبار شامل للمشاكل المتبقية</h1>
    
    <!-- تسجيل الدخول -->
    <div class="section">
        <h2>1. تسجيل دخول الموظف</h2>
        <form id="loginForm">
            <div class="form-group">
                <label>البريد الإلكتروني:</label>
                <input type="email" id="email" value="staff@bomba.com" required>
            </div>
            
            <div class="form-group">
                <label>كلمة المرور:</label>
                <input type="password" id="password" value="staff123" required>
            </div>
            
            <button type="submit">تسجيل الدخول</button>
        </form>
        <div id="loginResult"></div>
    </div>

    <!-- اختبار الصلاحيات -->
    <div class="section" id="permissionsSection" style="display: none;">
        <h2>2. اختبار صلاحيات الموظف</h2>
        <button onclick="testPermissions()">اختبار جميع الصلاحيات</button>
        <div id="permissionsResult"></div>
    </div>

    <!-- تغيير كلمة المرور -->
    <div class="section" id="passwordSection" style="display: none;">
        <h2>3. تغيير كلمة المرور</h2>
        <form id="changePasswordForm">
            <div class="form-group">
                <label>كلمة المرور الحالية:</label>
                <input type="password" id="currentPassword" value="staff123" required>
            </div>
            
            <div class="form-group">
                <label>كلمة المرور الجديدة:</label>
                <input type="password" id="newPassword" value="newstaff123" required>
            </div>
            
            <button type="submit">تغيير كلمة المرور</button>
        </form>
        <div id="passwordResult"></div>
    </div>

    <!-- اختبار كلمة المرور الجديدة -->
    <div class="section" id="newPasswordSection" style="display: none;">
        <h2>4. اختبار كلمة المرور الجديدة</h2>
        <button onclick="testNewPassword()">تسجيل دخول بكلمة المرور الجديدة</button>
        <button onclick="resetToOldPassword()">إعادة كلمة المرور للقديمة</button>
        <div id="newPasswordResult"></div>
    </div>

    <script>
        let authToken = '';
        let currentUser = null;

        // تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginData = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    authToken = result.data.token;
                    currentUser = result.data.user;
                    
                    showResult('loginResult', `
                        <h3>✅ تم تسجيل الدخول بنجاح!</h3>
                        <p><strong>المستخدم:</strong> ${currentUser.name}</p>
                        <p><strong>الدور:</strong> ${currentUser.role}</p>
                        <p><strong>الصلاحيات:</strong> ${currentUser.permissions.join(', ')}</p>
                        <p><strong>المنظمة:</strong> ${currentUser.organization}</p>
                    `, 'success');
                    
                    document.getElementById('permissionsSection').style.display = 'block';
                    document.getElementById('passwordSection').style.display = 'block';
                } else {
                    showResult('loginResult', `❌ فشل تسجيل الدخول: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `❌ خطأ في الشبكة: ${error.message}`, 'error');
            }
        });

        // اختبار الصلاحيات
        async function testPermissions() {
            const tests = [
                { name: 'الطلبات', endpoint: '/api/orders', permission: 'cafe' },
                { name: 'الطاولات', endpoint: '/api/tables/tables', permission: 'cafe' },
                { name: 'الفواتير', endpoint: '/api/bills', permission: 'billing' },
                { name: 'المنيو', endpoint: '/api/menu/items', permission: 'menu' },
                { name: 'الأجهزة', endpoint: '/api/devices', permission: 'playstation' }
            ];

            let results = '<h3>نتائج اختبار الصلاحيات:</h3>';
            
            for (const test of tests) {
                try {
                    const response = await fetch(`http://localhost:5000${test.endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    const hasPermission = currentUser.permissions.includes(test.permission) || currentUser.permissions.includes('all');
                    
                    if (response.ok) {
                        results += `<div class="test-item pass">✅ ${test.name}: نجح الوصول (${result.data?.length || 0} عنصر)</div>`;
                    } else {
                        if (hasPermission) {
                            results += `<div class="test-item fail">❌ ${test.name}: فشل رغم وجود الصلاحية - ${result.message}</div>`;
                        } else {
                            results += `<div class="test-item info">ℹ️ ${test.name}: لا توجد صلاحية (متوقع)</div>`;
                        }
                    }
                } catch (error) {
                    results += `<div class="test-item fail">❌ ${test.name}: خطأ في الشبكة - ${error.message}</div>`;
                }
            }
            
            document.getElementById('permissionsResult').innerHTML = results;
        }

        // تغيير كلمة المرور
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const passwordData = {
                currentPassword: document.getElementById('currentPassword').value,
                newPassword: document.getElementById('newPassword').value
            };
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(passwordData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('passwordResult', '✅ تم تغيير كلمة المرور بنجاح!', 'success');
                    document.getElementById('newPasswordSection').style.display = 'block';
                } else {
                    showResult('passwordResult', `❌ فشل تغيير كلمة المرور: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('passwordResult', `❌ خطأ: ${error.message}`, 'error');
            }
        });

        // اختبار كلمة المرور الجديدة
        async function testNewPassword() {
            const loginData = {
                email: 'staff@bomba.com',
                password: 'newstaff123'
            };
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('newPasswordResult', '✅ كلمة المرور الجديدة تعمل بنجاح!', 'success');
                } else {
                    showResult('newPasswordResult', `❌ كلمة المرور الجديدة لا تعمل: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('newPasswordResult', `❌ خطأ: ${error.message}`, 'error');
            }
        }

        // إعادة كلمة المرور للقديمة
        async function resetToOldPassword() {
            const passwordData = {
                currentPassword: 'newstaff123',
                newPassword: 'staff123'
            };
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(passwordData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('newPasswordResult', '✅ تم إعادة كلمة المرور للقديمة بنجاح!', 'success');
                } else {
                    showResult('newPasswordResult', `❌ فشل إعادة كلمة المرور: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('newPasswordResult', `❌ خطأ: ${error.message}`, 'error');
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }
    </script>
</body>
</html>