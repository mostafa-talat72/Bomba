# ุงูุฅุตูุงุญ ุงูููุงุฆู ููุดููุฉ ุชูููุฉ ุงูุฌูุณุฉ

## โ ุงูุชุญุฏูุซุงุช ุงูุฃุฎูุฑุฉ

### 1. ุฅุถุงูุฉ `markModified` (ููู ุฌุฏุงู!)
```javascript
this.totalCost = Math.round(total);
this.finalCost = this.totalCost - (this.discount || 0);

// โ ุฅุถุงูุฉ markModified ููุชุฃูุฏ ูู ุงูุญูุธ
this.markModified('totalCost');
this.markModified('finalCost');
```

**ููุงุฐุงุ** ูู ุจุนุถ ุงูุญุงูุงุชุ Mongoose ูุง ููุชุดู ุชููุงุฆูุงู ุฃู ุงูุญููู ุชุบูุฑุชุ ุฎุงุตุฉ ุฅุฐุง ูุงูุช ูุญุณูุจุฉ ุฏุงุฎู ุฏุงูุฉ.

### 2. ุฅุถุงูุฉ Logging ููุตู
ุชู ุฅุถุงูุฉ ุฑุณุงุฆู ุชุดุฎูุตูุฉ ูู:
- ุจุฏุงูุฉ `calculateCost`
- ุจุนุฏ ุฌูุจ ุจูุงูุงุช ุงูุฌูุงุฒ
- ุจุนุฏ ุญุณุงุจ ุงูุชูููุฉ
- ูุจู ูุจุนุฏ `endSession`
- ุจุนุฏ `save`

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู (ุฅูุฒุงููุฉ!)

### ุงูุฎุทูุฉ 1: ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุฑ
```bash
# ุฃููู ุงูุณูุฑูุฑ (Ctrl+C)
cd server
npm run dev
```

**โ๏ธ ูุฐู ุงูุฎุทูุฉ ุฅูุฒุงููุฉ! ุจุฏูููุง ูู ูุนูู ุงูุฅุตูุงุญ!**

### ุงูุฎุทูุฉ 2: ุฃููู ุฌูุณุฉ ุฌุฏูุฏุฉ
1. ุงุจุฏุฃ ุฌูุณุฉ ุจูุงูุณุชูุดู ุฌุฏูุฏุฉ
2. ุงูุชุธุฑ ุฏูููุฉ ุฃู ุงุซูุชูู
3. ุฃููู ุงูุฌูุณุฉ

### ุงูุฎุทูุฉ 3: ุฑุงูุจ ุงูู Terminal
ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงุฆู ูุซู:

```
๐ Before endSession: { totalCost: 0, finalCost: 0 }
๐ calculateCost STARTED for session: 674abc...
โ Device found: { type: 'playstation', ... }
๐ calculateCost result: { 
  totalCost: 28, 
  finalCost: 28,
  isModified_totalCost: true,
  isModified_finalCost: true
}
๐ After endSession: { totalCost: 28, finalCost: 28 }
๐ After save: { totalCost: 28, finalCost: 28 }
```

### ุงูุฎุทูุฉ 4: ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุงูุชุญ MongoDB ูุชุญูู ูู ุงูุฌูุณุฉ:
```javascript
db.sessions.findOne({ _id: ObjectId("...") })
```

ูุฌุจ ุฃู ุชุฑู:
```json
{
  "_id": "...",
  "totalCost": 28,
  "finalCost": 28,
  "status": "completed"
}
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ุชุธูุฑ ุฑุณุงุฆู console.log
**ุงูุณุจุจ:** ุงูุณูุฑูุฑ ูู ููุนุงุฏ ุชุดุบููู
**ุงูุญู:** ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุฑ

### ุงููุดููุฉ: ุชุธูุฑ "Device not found"
**ุงูุณุจุจ:** ุงูุฌูุณุฉ ุบูุฑ ูุฑุชุจุทุฉ ุจุฌูุงุฒ ุฃู ุงูุฌูุงุฒ ูุญุฐูู
**ุงูุญู:** ุชุฃูุฏ ูู ุฃู ุงูุฌูุณุฉ ููุง `deviceId` ุตุญูุญ

### ุงููุดููุฉ: totalCost = 0 ูู calculateCost result
**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:**
1. ุงูุฌูุงุฒ ููุณ ูู ุฃุณุนุงุฑ (`playstationRates` ูุงุฑุบ)
2. `controllers` ุบูุฑ ูุญุฏุฏ
3. `startTime` ุฃู `endTime` ุบูุฑ ุตุญูุญ
4. ุงููุฏุฉ ูุตูุฑุฉ ุฌุฏุงู (ุฃูู ูู ุฏูููุฉ)

**ุงูุญู:** ุชุญูู ูู ุงูุฑุณุงุฆู ุงูุชุดุฎูุตูุฉ ูุฃุฑุณููุง ูู

### ุงููุดููุฉ: isModified = false
**ุงูุณุจุจ:** Mongoose ูุง ููุชุดู ุงูุชุบููุฑ
**ุงูุญู:** ุชู ุฅุถุงูุฉ `markModified` - ูุฌุจ ุฃู ูุญู ุงููุดููุฉ

### ุงููุดููุฉ: ุงูููู ุตุญูุญุฉ ูู console ููู ุตูุฑ ูู DB
**ุงูุณุจุจ:** ุฎุทุฃ ูู ุงูุญูุธ ุฃู transaction rollback
**ุงูุญู:** ุชุญูู ูู ูุฌูุฏ ุฃุฎุทุงุก ูู console ุจุนุฏ "After save"

---

## ๐ ุงูุณููุงุฑูููุงุช ุงููุชููุนุฉ

### โ ุงูุณููุงุฑูู ุงูุตุญูุญ
```
๐ calculateCost STARTED
โ Device found
๐ calculateCost result: { totalCost: 28, finalCost: 28, isModified: true }
๐ After save: { totalCost: 28, finalCost: 28 }
```
โ ุงูุฌูุณุฉ ูุญููุธุฉ ุจุดูู ุตุญูุญ ูู DB โ

### โ ุงูุณููุงุฑูู 1: Device not found
```
๐ calculateCost STARTED
โ Device not found for deviceId: null
```
โ ุงููุดููุฉ: ุงูุฌูุณุฉ ุบูุฑ ูุฑุชุจุทุฉ ุจุฌูุงุฒ

### โ ุงูุณููุงุฑูู 2: Zero cost
```
๐ calculateCost result: { 
  rawTotal: 0, 
  totalCost: 0,
  controllers: undefined
}
```
โ ุงููุดููุฉ: controllers ุบูุฑ ูุญุฏุฏ ุฃู ุงูุฌูุงุฒ ุจุฏูู ุฃุณุนุงุฑ

### โ ุงูุณููุงุฑูู 3: Not modified
```
๐ calculateCost result: { 
  totalCost: 28,
  isModified_totalCost: false
}
```
โ ุงููุดููุฉ: Mongoose ูุง ููุชุดู ุงูุชุบููุฑ (ุชู ุฅุตูุงุญูุง ุจู markModified)

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู 3 ุฅุตูุงุญุงุช:
1. โ `async/await` ูู `endSession`
2. โ ูุนุงูุฌุฉ `discount` ุจุดูู ุตุญูุญ
3. โ **ุฅุถุงูุฉ `markModified`** ููุชุฃูุฏ ูู ุงูุญูุธ

**ุงูุขู:**
1. ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุฑ
2. ุฃููู ุฌูุณุฉ ุฌุฏูุฏุฉ
3. ุฑุงูุจ ุงูู console
4. ุฃุฑุณู ูู ุงูุฑุณุงุฆู ุฅุฐุง ูู ุชุนูู

---

## ๐ ููุงุญุธุฉ ูููุฉ

ุงูุฌูุณุงุช **ุงููุฏููุฉ** (ุงูุชู ุงูุชูุช ูุจู ุงูุฅุตูุงุญ) ุณุชุจูู ุจููู ุฎุงุทุฆุฉ.
ูุฅุตูุงุญูุงุ ุดุบู ุงูุณูุฑูุจุช:
```bash
cd server
node scripts/fixSessionCosts.js
```

ููู ุงูุฌูุณุงุช **ุงูุฌุฏูุฏุฉ** (ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู) ูุฌุจ ุฃู ุชูุญูุธ ุจุดูู ุตุญูุญ ุชููุงุฆูุงู! ๐
