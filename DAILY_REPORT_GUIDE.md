# دليل التقرير اليومي - نظام Bomba

## 📊 نظرة عامة

التقرير اليومي هو ميزة تلقائية ترسل ملخصاً شاملاً لأداء المنشأة يومياً عبر البريد الإلكتروني إلى جميع المديرين (Admin) في المنشأة.

## ⏰ الجدولة الزمنية

### التقرير اليومي
- **الوقت**: كل يوم في الساعة 11:59 مساءً
- **التكرار**: يومياً
- **المستلمون**: جميع المديرين (Admin) في المنشأة

### المهام الأخرى المجدولة
- **فحص المخزون المنخفض**: كل ساعة
- **التقرير الشهري**: آخر يوم من الشهر في الساعة 11:59 مساءً
- **تحديث الفواتير المتأخرة**: كل 6 ساعات
- **إنشاء التكاليف المتكررة**: كل يوم في منتصف الليل
- **نسخ احتياطي للقاعدة**: كل أسبوع يوم الأحد في الساعة 2 صباحاً
- **تنظيف الإشعارات المنتهية**: كل يوم في الساعة 3 صباحاً

## 📧 محتوى التقرير اليومي

### الإحصائيات الأساسية
- **إجمالي الإيرادات**: مجموع المدفوعات من الفواتير المدفوعة
- **إجمالي التكاليف**: مجموع التكاليف المسجلة في اليوم
- **صافي الربح**: الإيرادات - التكاليف
- **عدد الفواتير**: إجمالي الفواتير المدفوعة
- **عدد الطلبات**: إجمالي الطلبات المنجزة
- **عدد الجلسات**: إجمالي الجلسات المكتملة

### أكثر المنتجات مبيعاً
- قائمة بأفضل 5 منتجات من حيث الكمية المباعة
- ترتيب تنازلي حسب الكمية

## 🔧 متطلبات التشغيل

### متغيرات البيئة المطلوبة
```env
EMAIL_HOST=smtp.gmail.com
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
NODE_ENV=production
```

### متطلبات قاعدة البيانات
- **المنظمات**: يجب أن تكون موجودة في قاعدة البيانات
- **المستخدمون**: يجب أن يكون هناك مديرون (Admin) مع بريد إلكتروني صحيح
- **البيانات**: يجب أن تكون هناك فواتير وطلبات وجلسات لتوليد التقرير

## 🧪 الاختبار والتطوير

### في وضع التطوير
- التقرير اليومي يعمل كل ساعة للاختبار
- يمكن تشغيل التقرير يدوياً عبر زر "اختبار التقرير اليومي"

### سكريبتات الاختبار المتاحة
```bash
# فحص حالة الجدولة الزمنية
node check-scheduler.js

# اختبار التقرير اليومي
node test-email.js

# اختبار قاعدة البيانات
node test-database.js

# اختبار الجدولة الزمنية
node test-scheduler.js

# اختبار وضع الإنتاج
node test-production-scheduler.js
```

## 📋 خطوات التشغيل

### 1. التأكد من إعداد البريد الإلكتروني
```bash
# فحص متغيرات البيئة
node check-scheduler.js
```

### 2. التأكد من وجود البيانات
```bash
# فحص قاعدة البيانات
node test-database.js
```

### 3. اختبار التقرير
```bash
# اختبار إرسال التقرير
node test-email.js
```

### 4. تشغيل الخادم
```bash
npm start
```

## 🔍 مراقبة التشغيل

### سجلات التشغيل
- يتم تسجيل جميع عمليات الجدولة الزمنية
- يتم تسجيل نجاح أو فشل إرسال التقارير
- يتم تسجيل عدد المستلمين والمنظمات

### مؤشرات النجاح
- ✅ "Daily report sent for organization: [اسم المنظمة]"
- ✅ "Daily report generation completed for all organizations"

### مؤشرات الفشل
- ❌ "No admin emails found for organization: [اسم المنظمة]"
- ❌ "Failed to send daily report"

## 🛠️ استكشاف الأخطاء

### المشاكل الشائعة وحلولها

#### 1. عدم إرسال التقرير
**السبب**: عدم وجود مديرين مع بريد إلكتروني
**الحل**: إضافة مديرين مع بريد إلكتروني صحيح

#### 2. فشل إرسال البريد الإلكتروني
**السبب**: إعدادات البريد الإلكتروني غير صحيحة
**الحل**: التحقق من متغيرات البيئة EMAIL_HOST, EMAIL_USER, EMAIL_PASS

#### 3. عدم وجود بيانات للتقرير
**السبب**: عدم وجود فواتير أو طلبات في اليوم
**الحل**: التأكد من وجود نشاط في النظام

## 📞 الدعم

في حالة وجود مشاكل:
1. تشغيل `node check-scheduler.js` لفحص الحالة
2. مراجعة سجلات الخادم
3. التأكد من إعدادات البريد الإلكتروني
4. التحقق من وجود مديرين مع بريد إلكتروني

---

**ملاحظة**: التقرير اليومي يعمل تلقائياً ولا يحتاج إلى تدخل يدوي. في حالة الحاجة لاختبار التقرير، يمكن استخدام زر "اختبار التقرير اليومي" في لوحة التحكم.
