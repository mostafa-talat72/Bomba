# ุฏููู ุชุฑุญูู ูุฑุงุฌุน ุงูุทุงููุงุช (Table References Migration)

## ุงููุดููุฉ
ุงููุธุงู ุงูุญุงูู ูุณุชุฎุฏู `tableNumber` (string/number) ููุฑุจุท ุจูู ุงูุทุงููุงุช ูุงูููุงุชูุฑ ูุงูุทูุจุงุชุ ููุฐุง ุชุตููู ุบูุฑ ุตุญูุญ ูุณุจุจ ูุดุงูู ูู:
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุชุชุจุน ุงูุชุบููุฑุงุช ูู ุฃุฑูุงู ุงูุทุงููุงุช
- ุตุนูุจุฉ ูู ุงูุงุณุชุนูุงูุงุช ูุงูุชูุงุฑูุฑ
- ุนุฏู ูุฌูุฏ referential integrity
- ูุดุงูู ูู ุงูุฃุฏุงุก

## ุงูุญู
ุชุญููู ุงููุธุงู ูุงุณุชุฎุฏุงู `table` (ObjectId reference) ุจุฏูุงู ูู `tableNumber`.

## ุฎุทูุงุช ุงูุชุฑุญูู

### 1. ุงููุณุฎ ุงูุงุญุชูุงุทู (BACKUP)
**โ๏ธ ููู ุฌุฏุงู: ูู ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุชุดุบูู ุงูุณูุฑูุจุช!**

```bash
# MongoDB backup
mongodump --uri="mongodb://localhost:27017/bomba" --out=./backup-before-migration
```

### 2. ุชุดุบูู ุณูุฑูุจุช ุงูุชุฑุญูู

```bash
cd server
node scripts/migrateTableReferences.js
```

### 3. ูุฑุงุฌุนุฉ ุงูุชูุฑูุฑ
ุงูุณูุฑูุจุช ุณูุทุจุน ุชูุฑูุฑ ููุตู ููุถุญ:
- ุนุฏุฏ ุงูููุงุชูุฑ ูุงูุทูุจุงุช ุงูุชู ุชู ุชุฑุญูููุง ุจูุฌุงุญ
- ุงูููุงุชูุฑ/ุงูุทูุจุงุช ุงูุชู ูู ูุชู ุฅูุฌุงุฏ ุทุงููุฉ ูุทุงุจูุฉ ููุง
- ุฃู ุฃุฎุทุงุก ุญุฏุซุช ุฃุซูุงุก ุงูุชุฑุญูู

### 4. ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุบูุฑ ุงููุทุงุจูุฉ
ุฅุฐุง ูุงู ููุงู ููุงุชูุฑ ุฃู ุทูุจุงุช ูู ูุชู ุฅูุฌุงุฏ ุทุงููุฉ ูุทุงุจูุฉ ููุง:

#### ุงูุฎูุงุฑ 1: ุฅูุดุงุก ุงูุทุงููุงุช ุงูููููุฏุฉ
```javascript
// ูู MongoDB shell ุฃู Compass
db.tables.insertMany([
  {
    number: "A1",
    section: ObjectId("section_id_here"),
    organization: ObjectId("org_id_here"),
    isActive: true,
    createdBy: ObjectId("user_id_here"),
    createdAt: new Date(),
    updatedAt: new Date()
  }
]);
```

#### ุงูุฎูุงุฑ 2: ุชุนููู ุทุงููุฉ ุงูุชุฑุงุถูุฉ
```javascript
// ุชุญุฏูุซ ุงูููุงุชูุฑ/ุงูุทูุจุงุช ูุชุนููู ุทุงููุฉ ุงูุชุฑุงุถูุฉ
db.bills.updateMany(
  { tableNumber: "A1", table: { $exists: false } },
  { $set: { table: ObjectId("default_table_id") }, $unset: { tableNumber: 1 } }
);
```

#### ุงูุฎูุงุฑ 3: ุญุฐู ุงูุญูู ููุจูุงูุงุช ุงููุฏููุฉ
```javascript
// ุฅุฐุง ูุงูุช ุจูุงูุงุช ูุฏููุฉ ููุง ุชุญุชุงุฌ ูุฑุจุทูุง ุจุทุงููุฉ
db.bills.updateMany(
  { tableNumber: { $exists: true }, table: { $exists: false } },
  { $unset: { tableNumber: 1 } }
);
```

### 5. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุจุช (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
ุจุนุฏ ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุบูุฑ ุงููุทุงุจูุฉุ ููููู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุจุช:

```bash
node scripts/migrateTableReferences.js
```

## ูุง ููุนูู ุงูุณูุฑูุจุช

### ููููุงุชูุฑ (Bills):
1. ูุจุญุซ ุนู ูู ุงูููุงุชูุฑ ุงูุชู ุชุญุชูู ุนูู `tableNumber`
2. ููู ูุงุชูุฑุฉุ ูุจุญุซ ุนู ุงูุทุงููุฉ ุงููุทุงุจูุฉ ูู ููุณ ุงููุคุณุณุฉ
3. ุฅุฐุง ูุฌุฏ ุงูุทุงููุฉ:
   - ูุถูู ุญูู `table` ุจู ObjectId ุงูุทุงููุฉ
   - ูุญุฐู ุญูู `tableNumber`
4. ุฅุฐุง ูู ูุฌุฏ ุงูุทุงููุฉุ ูุณุฌู ุฐูู ูู ุงูุชูุฑูุฑ

### ููุทูุจุงุช (Orders):
ููุณ ุงูุนูููุฉ ููุทูุจุงุช.

## ูุซุงู ุนูู ุงูุชูุฑูุฑ

```
============================================================
๐ MIGRATION REPORT
============================================================

๐ Bills:
   Total: 150
   โ Matched & Updated: 145
   โ๏ธ  Not Matched: 5
   โ Errors: 0

๐ฆ Orders:
   Total: 320
   โ Matched & Updated: 315
   โ๏ธ  Not Matched: 5
   โ Errors: 0

๐ Summary:
   Total Documents: 470
   Successfully Migrated: 460
   Not Matched: 10
   Errors: 0

โ๏ธ  Bills with no matching table:
   - Bill: BILL-2411201234567890, tableNumber: "A1", org: 507f1f77bcf86cd799439011
   - Bill: BILL-2411201234567891, tableNumber: "B2", org: 507f1f77bcf86cd799439011

โ๏ธ  Orders with no matching table:
   - Order: ORD-2411201234567892, tableNumber: "A1", org: 507f1f77bcf86cd799439011
============================================================
```

## ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุฑุญูู

### ูู MongoDB Shell:
```javascript
// ุงูุชุญูู ูู ุนุฏุฏ ุงูููุงุชูุฑ ุงูุชู ุชู ุชุฑุญูููุง
db.bills.countDocuments({ table: { $exists: true } })

// ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ tableNumber
db.bills.countDocuments({ tableNumber: { $exists: true } })

// ููุณ ุงูุดูุก ููุทูุจุงุช
db.orders.countDocuments({ table: { $exists: true } })
db.orders.countDocuments({ tableNumber: { $exists: true } })
```

### ูู ุงูุชุทุจูู:
ุจุนุฏ ุงูุชุฑุญููุ ุชุฃูุฏ ูู:
1. ุนุฑุถ ุงูููุงุชูุฑ ูุงูุทูุจุงุช ุจุดูู ุตุญูุญ
2. ุฅูุดุงุก ููุงุชูุฑ ูุทูุจุงุช ุฌุฏูุฏุฉ
3. ุงูุชูุงุฑูุฑ ุชุนูู ุจุดูู ุตุญูุญ

## ุงูุฎุทูุฉ ุงูุชุงููุฉ
ุจุนุฏ ูุฌุงุญ ุงูุชุฑุญููุ ูุฌุจ:
1. ุชุญุฏูุซ Models ูุงุณุชุฎุฏุงู `table` ุจุฏูุงู ูู `tableNumber`
2. ุชุญุฏูุซ Controllers ูุงูู API endpoints
3. ุชุญุฏูุซ Frontend ูุงุณุชุฎุฏุงู table ObjectId
4. ุญุฐู ูู ุงูููุฏ ุงููุชุนูู ุจู `tableNumber`

## ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ูู ุญุงูุฉ ุงูุทูุงุฑุฆ)

```bash
# Restore from backup
mongorestore --uri="mongodb://localhost:27017/bomba" --drop ./backup-before-migration/bomba
```

## ููุงุญุธุงุช ูููุฉ
- ุงูุณูุฑูุจุช ุขูู ููููู ุชุดุบููู ุนุฏุฉ ูุฑุงุช (idempotent)
- ูุง ูุญุฐู ุฃู ุจูุงูุงุชุ ููุท ูุถูู ุญูู ุฌุฏูุฏ ููุญุฐู ุงููุฏูู
- ูุนูู ุนูู ูุณุชูู ุงููุคุณุณุฉ (organization) ูุถูุงู ุงูุฏูุฉ
- ูุชุนุงูู ูุน ุงูุทุงููุงุช ุงููุดุทุฉ ููุท (`isActive: true`)

## ุงูุฏุนู
ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุฑุงุฌุน ุงูุชูุฑูุฑ ุงููุทุจูุน ูู ุงูุณูุฑูุจุช
2. ุชุญูู ูู logs MongoDB
3. ุชุฃูุฏ ูู ุตุญุฉ ุจูุงูุงุช ุงูุทุงููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
