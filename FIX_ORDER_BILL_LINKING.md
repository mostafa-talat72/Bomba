# إصلاح مشكلة الطلبات والفواتير

## المشكلة
في صفحة الفواتير وصفحة الطلبات، هناك بعض الأقسام مكتوب فيها طلبات ولكن الطاولة تبقى فارغة من المفترض أن تكون محجوزة. وأيضاً في صفحة الفواتير لا تظهر هذه الفواتير المرتبطة بهذه الطلبات مع أنه مكتوب في قاعدة البيانات `occupied`.

**السبب:** الطاولات محجوزة في قاعدة البيانات بشكل صحيح، لكن:
- بعض الفواتير تحتوي على طلبات لكن غير مرتبطة بطاولة
- الطلبات مرتبطة بفواتير لكن الفواتير غير مرتبطة بطاولات
- الواجهة الأمامية تعتمد على الفواتير لتحديد حالة الطاولة

## الحل

### الخطوة 1: فحص المشكلة
قم بتشغيل هذا الأمر لفحص البيانات ومعرفة حجم المشكلة:

```bash
node server/scripts/checkOrderBillLinking.js
```

سيعرض لك تقرير مفصل عن:
- عدد الطلبات التي لها مشاكل
- عدد الفواتير التي لها مشاكل
- عدد الطاولات التي حالتها غير صحيحة

### الخطوة 2: إصلاح المشكلة
بعد الفحص، قم بتشغيل هذا الأمر لإصلاح جميع المشاكل:

```bash
node server/scripts/fixOrderBillLinking.js
```

سيقوم بـ:
- ✅ ربط الطلبات بالفواتير بشكل صحيح
- ✅ إنشاء فواتير جديدة للطلبات التي بدون فاتورة
- ✅ ربط الفواتير بالطاولات (من خلال الطلبات المرتبطة بها)
- ✅ تحديث حالات الطاولات
- ✅ إعادة حساب إجماليات الفواتير

### الخطوة 3: التحقق من الإصلاح
قم بتشغيل أمر الفحص مرة أخرى للتأكد من أن جميع المشاكل تم إصلاحها:

```bash
node server/scripts/checkOrderBillLinking.js
```

يجب أن ترى رسالة: "✅ لا توجد مشاكل! جميع البيانات متسقة."

## ملاحظات مهمة

⚠️ **قبل الإصلاح:**
- يفضل عمل نسخة احتياطية من قاعدة البيانات
- تأكد من عدم وجود مستخدمين يعملون على النظام

✅ **بعد الإصلاح:**
- قم بتحديث صفحة الفواتير في المتصفح (F5)
- قم بتحديث صفحة الطلبات في المتصفح (F5)
- تحقق من أن الطاولات تظهر بالحالة الصحيحة

## إذا استمرت المشكلة

إذا استمرت المشكلة بعد الإصلاح:
1. تحقق من console في المتصفح (F12) لمعرفة إذا كان هناك أخطاء
2. تحقق من logs الخاصة بالـ server
3. تأكد من أن Socket.IO يعمل بشكل صحيح
4. قم بإعادة تشغيل الـ server

## الوقاية من المشكلة في المستقبل

تم تحديث الكود لضمان عدم حدوث هذه المشكلة مرة أخرى:
- ✅ كل طلب جديد يتم ربطه بفاتورة تلقائياً
- ✅ حالة الطاولة يتم تحديثها تلقائياً
- ✅ الفواتير يتم تحديثها فوراً عبر Socket.IO

## للمزيد من التفاصيل

راجع ملف: `server/scripts/README_ORDER_BILL_LINKING.md`
