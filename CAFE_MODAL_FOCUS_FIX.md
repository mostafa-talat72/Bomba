# إصلاح تركيز الإدخال وإعادة تعيين حالة النوافذ في صفحة الطلبات

## المشكلة
عند فتح أي نافذة منبثقة (Modal) في صفحة الطلبات:
1. لم يكن التركيز (focus) يُعاد تعيينه بشكل صحيح
2. كانت النافذة تحتفظ بالحالة السابقة (الأقسام المفتوحة، نص البحث، إلخ)
3. المستخدم يحتاج للنقر يدوياً وإعادة ضبط كل شيء في كل مرة

## الحل المطبق

تم تطبيق حلين متكاملين:

### الحل الأول: إعادة تعيين الحالة عند فتح النافذة

#### 1. نافذة الطلب الجديد (handleAddOrder)
```typescript
const handleAddOrder = () => {
  if (!selectedTable) {
    showNotification('يرجى اختيار طاولة أولاً', 'error');
    return;
  }
  // إعادة تعيين كل شيء كأنها المرة الأولى
  setCurrentOrderItems([]);
  setOrderNotes('');
  setExpandedSections({});      // ✅ إغلاق جميع الأقسام
  setExpandedCategories({});    // ✅ إغلاق جميع الفئات
  setShowOrderModal(true);
};
```

#### 2. نافذة تعديل الطلب (handleEditOrder)
```typescript
const handleEditOrder = (order: Order) => {
  setSelectedOrder(order);
  // ... تحميل بيانات الطلب
  setCurrentOrderItems(items);
  setOrderNotes(order.notes || '');
  // إعادة تعيين الأقسام والفئات المفتوحة
  setExpandedSections({});      // ✅ إغلاق جميع الأقسام
  setExpandedCategories({});    // ✅ إغلاق جميع الفئات
  setShowEditOrderModal(true);
};
```

### الحل الثاني: تركيز تلقائي على حقول الإدخال

#### 1. نافذة الطلب الجديد/تعديل الطلب (OrderModal)
- **الحقل المستهدف**: حقل البحث عن العناصر
- **التحسينات**:
  - إضافة `searchInputRef` للإشارة إلى حقل البحث
  - إضافة `useEffect` لتركيز الحقل تلقائياً عند فتح النافذة
  - مسح نص البحث السابق عند فتح النافذة من جديد
  - تأخير 100ms لضمان عرض النافذة قبل التركيز

```typescript
const searchInputRef = useRef<HTMLInputElement>(null);

useEffect(() => {
  setSearchQuery('');           // ✅ مسح نص البحث السابق
  const timer = setTimeout(() => {
    searchInputRef.current?.focus();  // ✅ تركيز تلقائي
  }, 100);
  return () => clearTimeout(timer);
}, []);
```

#### 2. نافذة إضافة/تعديل قسم (SectionModal)
- **الحقل المستهدف**: حقل اسم القسم
- **التحسينات**:
  - إضافة `nameInputRef` للإشارة إلى حقل الاسم
  - تركيز تلقائي عند فتح النافذة

```typescript
const nameInputRef = useRef<HTMLInputElement>(null);

useEffect(() => {
  const timer = setTimeout(() => {
    nameInputRef.current?.focus();
  }, 100);
  return () => clearTimeout(timer);
}, []);
```

#### 3. نافذة إضافة/تعديل طاولة (TableModal)
- **الحقل المستهدف**: حقل رقم/اسم الطاولة
- **التحسينات**:
  - إضافة `numberInputRef` للإشارة إلى حقل الرقم
  - تركيز تلقائي عند فتح النافذة

```typescript
const numberInputRef = useRef<HTMLInputElement>(null);

useEffect(() => {
  const timer = setTimeout(() => {
    numberInputRef.current?.focus();
  }, 100);
  return () => clearTimeout(timer);
}, []);
```

## الفوائد

1. **تجربة مستخدم أفضل**: المستخدم يمكنه البدء بالكتابة فوراً دون الحاجة للنقر
2. **سرعة أكبر**: توفير الوقت في العمليات المتكررة
3. **اتساق**: جميع النوافذ تتصرف بنفس الطريقة كأنها تُفتح لأول مرة
4. **نظافة البيانات**: 
   - مسح نص البحث السابق
   - إغلاق جميع الأقسام والفئات المفتوحة
   - إعادة تعيين حالة النافذة بالكامل
5. **واجهة نظيفة**: النافذة تبدأ دائماً من حالة افتراضية واضحة

## الملفات المعدلة

- `src/pages/Cafe.tsx`: تحديث جميع مكونات النوافذ المنبثقة

## الاختبار

للتأكد من عمل الإصلاح:

### اختبار نافذة الطلب الجديد
1. افتح صفحة الطلبات
2. اختر طاولة وافتح نافذة "طلب جديد"
   - ✅ يجب أن يكون التركيز على حقل البحث تلقائياً
   - ✅ يجب أن يكون حقل البحث فارغاً
   - ✅ يجب أن تكون جميع الأقسام مغلقة
3. افتح بعض الأقسام والفئات، ابحث عن عنصر
4. أغلق النافذة وافتحها مرة أخرى
   - ✅ يجب أن تكون جميع الأقسام مغلقة مرة أخرى
   - ✅ يجب أن يكون حقل البحث فارغاً
   - ✅ يجب أن يكون التركيز على حقل البحث

### اختبار نافذة تعديل الطلب
1. افتح طلب موجود للتعديل
2. افتح بعض الأقسام
3. أغلق النافذة وافتح نفس الطلب مرة أخرى
   - ✅ يجب أن تكون جميع الأقسام مغلقة
   - ✅ يجب أن يكون التركيز على حقل البحث

### اختبار نوافذ إدارة الطاولات
1. افتح نافذة "إدارة الطاولات"
2. اضغط "إضافة قسم"
   - ✅ يجب أن يكون التركيز على حقل "اسم القسم"
3. اضغط "إضافة طاولة"
   - ✅ يجب أن يكون التركيز على حقل "رقم/اسم الطاولة"

## ملاحظات تقنية

### إعادة تعيين الحالة
- يتم إعادة تعيين `expandedSections` و `expandedCategories` إلى `{}` (كائن فارغ) عند فتح النافذة
- هذا يضمن أن جميع الأقسام والفئات تبدأ مغلقة في كل مرة
- يتم ذلك في دوال `handleAddOrder` و `handleEditOrder` قبل فتح النافذة

### التركيز التلقائي
- استخدام `setTimeout` بـ 100ms ضروري لضمان عرض النافذة في DOM قبل محاولة التركيز
- استخدام `useEffect` مع dependency array فارغ `[]` يضمن تنفيذ الكود مرة واحدة عند mount المكون
- استخدام optional chaining `?.` يمنع الأخطاء إذا لم يكن العنصر موجوداً بعد

### الأداء
- إعادة تعيين الحالة لا تؤثر على الأداء لأنها عملية بسيطة جداً
- التركيز التلقائي يحدث مرة واحدة فقط عند فتح النافذة
