# نظام الصلاحيات المحسن - Bomba System

## نظرة عامة

تم تطبيق نظام صلاحيات محسن ومتكامل يضمن عرض الصفحات والإشعارات حسب صلاحيات كل مستخدم. كل صلاحية تمنح **التحكم الكامل** في القسم المحدد.

## فلسفة النظام

### مبدأ التحكم الكامل
كل صلاحية تمنح المستخدم **التحكم الكامل** في القسم المحدد:
- **cafe**: التحكم الكامل في طلبات الكافيه والمشروبات والخدمة
- **playstation**: التحكم الكامل في أجهزة البلايستيشن وجلسات اللعب
- **computer**: التحكم الكامل في أجهزة الكمبيوتر وجلسات الاستخدام
- **menu**: التحكم الكامل في قائمة الطعام والمشروبات والأسعار
- **billing**: التحكم الكامل في إنشاء وإدارة الفواتير والمدفوعات
- **inventory**: التحكم الكامل في المخزون والأصناف والمشتريات
- **costs**: التحكم الكامل في التكاليف والمصروفات والميزانية
- **reports**: التحكم الكامل في عرض وتصدير جميع التقارير
- **users**: التحكم الكامل في المستخدمين والصلاحيات والأدوار
- **settings**: التحكم الكامل في إعدادات النظام والتكوين

## الميزات المضافة

### 1. نظام الصلاحيات المحسن

#### الأدوار المتاحة:
- **مدير (admin)**: صلاحيات كاملة على النظام - جميع الصلاحيات
- **موظف (staff)**: صلاحيات محدودة - لوحة التحكم، التقارير، الإعدادات
- **كاشير (cashier)**: إدارة المبيعات والفواتير - الكافيه، المنيو، الفواتير، التقارير
- **مطبخ (kitchen)**: إدارة الطلبات والمطبخ - الكافيه، المنيو، المخزون، التكاليف

#### الصلاحيات المتاحة:
- `dashboard`: التحكم الكامل في لوحة التحكم وعرض الإحصائيات والتقارير
- `playstation`: التحكم الكامل في أجهزة البلايستيشن وجلسات اللعب
- `computer`: التحكم الكامل في أجهزة الكمبيوتر وجلسات الاستخدام
- `cafe`: التحكم الكامل في طلبات الكافيه والمشروبات والخدمة
- `menu`: التحكم الكامل في قائمة الطعام والمشروبات والأسعار
- `billing`: التحكم الكامل في إنشاء وإدارة الفواتير والمدفوعات
- `reports`: التحكم الكامل في عرض وتصدير جميع التقارير
- `inventory`: التحكم الكامل في المخزون والأصناف والمشتريات
- `costs`: التحكم الكامل في التكاليف والمصروفات والميزانية
- `users`: التحكم الكامل في المستخدمين والصلاحيات والأدوار
- `settings`: التحكم الكامل في إعدادات النظام والتكوين
- `all`: وصول كامل لجميع الميزات والتحكم الكامل في النظام

### 2. حماية المسارات

#### مكون ProtectedRoute:
- يتحقق من صلاحيات المستخدم قبل عرض الصفحة
- إعادة توجيه ذكية للصفحة الأولى المتاحة إذا لم يكن لديه صلاحية
- دعم التحقق من الأدوار والصلاحيات

#### مكون PermissionGuard:
- مكون قابل لإعادة الاستخدام للتحقق من الصلاحيات
- دعم عرض/إخفاء المحتوى حسب الصلاحيات
- دعم fallback content

### 3. تصفية الإشعارات حسب الصلاحيات

#### تحسينات خدمة الإشعارات:
- `getUserNotificationsWithPermissionFilter`: تصفية محسنة حسب الصلاحيات
- `getNotificationStatsWithPermissions`: إحصائيات حسب الصلاحيات
- تصفية تلقائية للإشعارات حسب دور المستخدم وصلاحياته

#### أنواع الإشعارات:
- **الجلسات**: للمستخدمين ذوي صلاحية playstation/computer
- **الطلبات**: للمستخدمين ذوي صلاحية cafe
- **المخزون**: للمستخدمين ذوي صلاحية inventory
- **الفواتير**: للمستخدمين ذوي صلاحية billing
- **النظام**: للمديرين

### 4. واجهة مستخدم محسنة

#### صفحة إدارة الإشعارات:
- عرض الإشعارات حسب صلاحيات المستخدم
- فلترة حسب الفئة والحالة
- بحث في الإشعارات
- إحصائيات مفصلة

#### صفحة إدارة المستخدمين:
- عرض الصفحات المتاحة لكل مستخدم
- إدارة الصلاحيات بشكل مرئي
- عرض تفاصيل شاملة للمستخدم
- أوصاف واضحة لكل صلاحية ودور

## كيفية الاستخدام

### 1. إضافة صلاحيات جديدة:

```javascript
// في server/models/User.js
const pagePermissions = {
  newPage: ['requiredPermission1', 'requiredPermission2']
};
```

### 2. حماية صفحة جديدة:

```jsx
// في App.tsx
<Route path="newpage" element={
  <ProtectedRoute requiredPermissions={['requiredPermission']}>
    <NewPage />
  </ProtectedRoute>
} />
```

### 3. إخفاء عنصر حسب الصلاحيات:

```jsx
<PermissionGuard requiredPermissions={['admin']}>
  <AdminOnlyComponent />
</PermissionGuard>
```

### 4. إضافة إشعار جديد:

```javascript
// في server/models/Notification.js
const notifications = {
  newType: {
    title: "عنوان الإشعار",
    message: "محتوى الإشعار",
    targetRoles: ["admin", "staff"],
    targetPermissions: ["requiredPermission"]
  }
};
```

## الصلاحيات الافتراضية لكل دور

### المدير (admin):
- جميع الصلاحيات (`all`) - التحكم الكامل في النظام

### الموظف (staff):
- `dashboard` - التحكم الكامل في لوحة التحكم
- `reports` - التحكم الكامل في التقارير
- `settings` - التحكم الكامل في الإعدادات

### الكاشير (cashier):
- `dashboard` - التحكم الكامل في لوحة التحكم
- `cafe` - التحكم الكامل في طلبات الكافيه
- `menu` - التحكم الكامل في قائمة الطعام
- `billing` - التحكم الكامل في الفواتير
- `reports` - التحكم الكامل في تقارير المبيعات

### المطبخ (kitchen):
- `dashboard` - التحكم الكامل في لوحة التحكم
- `cafe` - التحكم الكامل في طلبات الكافيه
- `menu` - التحكم الكامل في قائمة الطعام
- `inventory` - التحكم الكامل في المخزون
- `costs` - التحكم الكامل في التكاليف

## تحديث المستخدمين الموجودين

لتحديث صلاحيات المستخدمين الموجودين، قم بتشغيل:

```bash
cd server
node scripts/updatePermissionsByRole.js
```

هذا السكريبت سيقوم بـ:
- تحديث صلاحيات المستخدمين حسب أدوارهم
- عدم تغيير الصلاحيات المخصصة للمستخدمين
- عرض تقرير مفصل عن التحديثات

## الأمان

### التحقق من الصلاحيات:
- تحقق مزدوج في الواجهة الأمامية والخلفية
- حماية المسارات على مستوى التطبيق
- تصفية البيانات حسب الصلاحيات

### الإشعارات:
- تصفية تلقائية حسب الصلاحيات
- عدم إرسال إشعارات غير مخصصة للمستخدم
- حماية معلومات حساسة

## استكشاف الأخطاء

### مشاكل شائعة:

1. **المستخدم لا يرى الصفحات**:
   - تحقق من صلاحيات المستخدم في قاعدة البيانات
   - تأكد من أن الصفحة محمية بـ ProtectedRoute

2. **الإشعارات لا تظهر**:
   - تحقق من صلاحيات المستخدم
   - تأكد من أن الإشعار يستهدف الدور الصحيح

3. **خطأ في الوصول**:
   - تحقق من middleware auth.js
   - تأكد من أن المستخدم نشط

## التطوير المستقبلي

### ميزات مقترحة:
- نظام أدوار مخصصة
- صلاحيات ديناميكية
- سجل الصلاحيات
- إدارة الصلاحيات المتقدمة
- نظام الموافقات

### تحسينات الأداء:
- تخزين مؤقت للصلاحيات
- تحسين استعلامات قاعدة البيانات
- تحميل تدريجي للصلاحيات
