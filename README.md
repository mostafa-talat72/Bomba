# Bastira - نظام إدارة الكافيه والبلايستيشن

نظام شامل لإدارة الكافيهات وصالات الألعاب مع دعم كامل للعربية وميزات متقدمة للإدارة والتقارير.

## 🌟 المميزات الرئيسية

### 🎮 إدارة الألعاب
- **البلايستيشن**: إدارة الجلسات مع دعم متعدد الدراعات وتسعير ديناميكي
- **الكمبيوتر**: نظام جلسات بسيط بتسعير ثابت
- **متابعة الوقت الفعلي**: تتبع الجلسات النشطة والمنتهية

### ☕ إدارة الكافيه
- **منيو ديناميكي**: إضافة وتعديل المنتجات والأسعار
- **إدارة الطلبات**: من الطلب إلى التحضير والتسليم
- **ملاحظات مخصصة**: إضافة ملاحظات لكل طلب
- **تتبع المخزون**: خصم تلقائي من المواد الخام

### 💰 نظام الفواتير
- **فواتير شاملة**: دمج طلبات الكافيه وجلسات الألعاب
- **دفع جزئي**: إمكانية الدفع على دفعات
- **رموز QR**: للعملاء لعرض الفواتير
- **طباعة**: دعم طباعة الفواتير

### 📊 التقارير والإحصائيات
- **تقارير مالية**: إيرادات، تكاليف، أرباح
- **تقارير المبيعات**: أكثر المنتجات مبيعاً، ذروة الأوقات
- **تقارير المخزون**: حالة المخزون، الحركات
- **تقارير الجلسات**: استخدام الأجهزة، الإيرادات

## 🛠️ التقنيات المستخدمة

### Frontend
- **React 18** مع TypeScript
- **Tailwind CSS** للتصميم
- **React Router** للتنقل
- **Lucide React** للأيقونات

### Backend
- **Node.js** مع Express
- **MongoDB Atlas** (قاعدة بيانات سحابية)
- **JWT** للمصادقة
- **Socket.IO** للتحديثات المباشرة

## 🚀 التثبيت والتشغيل

### متطلبات النظام
- Node.js 18+
- حساب MongoDB Atlas
- npm أو yarn

### خطوات التثبيت

1. **استنساخ المشروع**
```bash
git clone https://github.com/your-repo/bastira.git
cd bastira
```

2. **تثبيت التبعيات**
```bash
# Install all dependencies (frontend + backend)
npm run install:all
```

3. **إعداد MongoDB Atlas**
   - اذهب إلى [MongoDB Atlas](https://cloud.mongodb.com/)
   - أنشئ حساب جديد أو سجل دخول
   - أنشئ Cluster جديد (يمكنك استخدام الخطة المجانية)
   - اذهب إلى **Database Access** وأنشئ مستخدم جديد
   - اذهب إلى **Network Access** وأضف عنوان IP الخاص بك (أو 0.0.0.0/0 للتطوير)
   - احصل على connection string من **Connect > Connect your application**

4. **إعداد متغيرات البيئة**
```bash
cd server
cp .env.example .env
# قم بتعديل ملف .env وأضف connection string الخاص بك
```

في ملف `server/.env`، استبدل `MONGODB_URI` بـ connection string الخاص بك:
```env
MONGODB_URI=mongodb+srv://username:password@cluster-name.mongodb.net/bastira?retryWrites=true&w=majority
```

5. **اختبار الاتصال بقاعدة البيانات**
```bash
cd server
node scripts/testConnection.js
```

6. **إنشاء المستخدم الأول (Admin)**
```bash
npm run seed:admin
```

7. **تشغيل التطبيق**
```bash
# تشغيل Frontend و Backend معاً
npm run dev
```

أو تشغيلهما منفصلين:
```bash
# Frontend (في terminal منفصل)
npm run client:dev

# Backend (في terminal آخر)
npm run server:dev
```

## 🌐 الوصول للتطبيق

- **Frontend**: http://localhost:3000
- **Backend API**: http://localhost:5000/api
- **Health Check**: http://localhost:5000/health

### بيانات الدخول الافتراضية
- **البريد الإلكتروني**: admin@bastira.com
- **كلمة المرور**: admin123

## 🔧 استكشاف الأخطاء

### مشاكل الاتصال بـ MongoDB Atlas

إذا واجهت مشاكل في الاتصال:

1. **تحقق من IP Whitelist**:
   - اذهب إلى MongoDB Atlas > Network Access
   - تأكد من إضافة عنوان IP الخاص بك
   - للتطوير، يمكنك إضافة 0.0.0.0/0 (غير آمن للإنتاج)

2. **تحقق من بيانات المستخدم**:
   - اذهب إلى Database Access
   - تأكد من صحة اسم المستخدم وكلمة المرور
   - تأكد من أن المستخدم له صلاحيات القراءة والكتابة

3. **تحقق من Connection String**:
   ```env
   # تأكد من استبدال هذه القيم بالقيم الصحيحة
   mongodb+srv://<username>:<password>@<cluster-name>.mongodb.net/<database-name>?retryWrites=true&w=majority
   ```

4. **اختبار الاتصال**:
   ```bash
   cd server
   node scripts/testConnection.js
   ```

### مشاكل أخرى شائعة

- **Port already in use**: تأكد من عدم تشغيل تطبيقات أخرى على نفس المنافذ
- **JWT errors**: تأكد من وجود JWT_SECRET في ملف .env
- **CORS errors**: التطبيق معد للعمل مع proxy، تأكد من تشغيل كلا الخادمين

## 📁 هيكل المشروع

```
bastira/
├── src/                    # Frontend React
│   ├── components/         # مكونات React
│   ├── pages/             # صفحات التطبيق
│   ├── context/           # إدارة الحالة
│   ├── services/          # API calls
│   └── utils/             # أدوات مساعدة
├── server/                # Backend Node.js
│   ├── controllers/       # منطق العمليات
│   ├── models/           # نماذج قاعدة البيانات
│   ├── routes/           # مسارات API
│   ├── middleware/       # وسطاء Express
│   ├── config/           # إعدادات قاعدة البيانات
│   ├── scripts/          # سكريبتات مساعدة
│   └── utils/            # أدوات مساعدة
└── docs/                 # التوثيق
```

## 🔒 الأمان

- **تشفير كلمات المرور** باستخدام bcrypt
- **JWT Tokens** للمصادقة
- **Rate Limiting** لمنع الهجمات
- **CORS Protection** للحماية من الطلبات الضارة
- **Input Validation** للتحقق من البيانات
- **MongoDB Atlas Security** مع IP whitelisting وتشفير البيانات

## 📞 الدعم

إذا واجهت أي مشاكل:

1. تحقق من ملف README
2. راجع رسائل الخطأ في console
3. تأكد من إعدادات MongoDB Atlas
4. تحقق من متغيرات البيئة في ملف .env

## المميزات الجديدة

### 1. تحسينات نظام الدفع

#### دفع الفاتورة بالكامل
- دفع الفاتورة بالكامل بنقرة واحدة
- دفع المبلغ المتبقي تلقائياً
- عرض المبلغ المدفوع والمتبقي
- مؤشرات بصرية لحالة الدفع

#### دفع مشروبات محددة
- إمكانية اختيار مشروبات محددة للدفع
- تحديد كمية معينة من كل مشروب (مثلاً: دفع 2 من 3 شاي)
- عرض قائمة بجميع المشروبات في الفاتورة
- إمكانية تحديد مشروبات متعددة للدفع
- عرض إجمالي المبلغ المطلوب للدفع
- عرض الكمية المتبقية في الفاتورة

#### طرق الدفع المتاحة
- نقداً (Cash)
- بطاقة (Card)
- تحويل (Transfer)

### 2. تحسينات عرض تفاصيل الجلسات

#### تفاصيل الساعات حسب عدد الدواسات
- عرض تفاصيل الساعات لكل فترة استخدام
- إظهار عدد الدواسات المستخدمة في كل فترة
- حساب التكلفة لكل فترة حسب عدد الدواسات
- عرض إجمالي التكلفة لكل فترة

#### مثال على العرض:
```
تفاصيل الساعات حسب عدد الدواسات:
2 دراع: 1 ساعة 30 دقيقة - 30 ج.م
3 دراع: 45 دقيقة - 18.75 ج.م
```

#### مثال على الدفع:
```
دفع الفاتورة بالكامل:
- المبلغ المدفوع: 48.75 ج.م
- المبلغ المتبقي: 0 ج.م
- الحالة: ستصبح الفاتورة مدفوعة بالكامل!

دفع مشروبات محددة:
- شاي × 2 (من أصل 3) = 20 ج.م
- قهوة × 1 (من أصل 1) = 15 ج.م
- إجمالي الدفع: 35 ج.م
- المتبقي في الفاتورة: 1 شاي
```

## كيفية الاستخدام

### إدارة الدفع

1. **دفع الفاتورة بالكامل:**
   - اختر "دفع الفاتورة بالكامل"
   - سيتم تعيين المبلغ المتبقي تلقائياً
   - اختر طريقة الدفع
   - اضغط "دفع الفاتورة بالكامل"

2. **دفع مشروبات محددة:**
   - اختر "دفع مشروب معين"
   - حدد المشروبات المطلوب دفعها
   - حدد الكمية المطلوب دفعها من كل مشروب
   - اختر طريقة الدفع
   - اضغط "تأكيد الدفع الجزئي"

### عرض تفاصيل الجلسات

- في صفحة عرض الفاتورة، ستظهر تفاصيل الجلسات
- لجلسات البلايستيشن، ستظهر تفاصيل الساعات حسب عدد الدواسات
- كل فترة استخدام تظهر مع عدد الدواسات والتكلفة

## الأسعار

### البلايستيشن
- 1-2 دراع: 20 ج.م/ساعة
- 3 دراع: 25 ج.م/ساعة
- 4 دراع: 30 ج.م/ساعة

### الكمبيوتر
- 15 ج.م/ساعة

## التقنيات المستخدمة

### Backend
- Node.js
- Express.js
- MongoDB
- Mongoose

### Frontend
- React
- TypeScript
- Tailwind CSS
- Vite

## التثبيت والتشغيل

### متطلبات النظام
- Node.js 16+
- MongoDB 4.4+

### تثبيت التبعيات
```bash
# تثبيت تبعيات الخادم
cd server
npm install

# تثبيت تبعيات الواجهة الأمامية
cd ..
npm install
```

### تشغيل التطبيق
```bash
# تشغيل الخادم
cd server
npm start

# تشغيل الواجهة الأمامية (في terminal آخر)
npm run dev
```

## الملفات المحدثة

### Backend
- `server/controllers/billingController.js` - تحسين استعلامات الجلسات
- `server/models/Session.js` - نموذج الجلسات مع controllersHistory

### Frontend
- `src/pages/Billing.tsx` - تحسين واجهة الدفع
- `src/pages/BillView.tsx` - تحسين عرض تفاصيل الجلسات
- `src/services/api.ts` - تحديث واجهات API

## المساهمة

للمساهمة في المشروع:
1. Fork المشروع
2. إنشاء branch جديد للميزة
3. Commit التغييرات
4. Push إلى Branch
5. إنشاء Pull Request

## الترخيص

هذا المشروع مرخص تحت رخصة MIT.

---

**Bastira** - نظام إدارة شامل للكافيهات وصالات الألعاب 🎮☕
