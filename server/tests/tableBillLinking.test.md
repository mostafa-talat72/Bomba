# اختبار ربط الفواتير بالطاولات

## سيناريوهات الاختبار

### ✅ السيناريو 1: بدء جلسة بلايستيشن على طاولة فارغة

**الخطوات:**
1. اذهب إلى صفحة الأجهزة
2. ابدأ جلسة PS1 على طاولة 5
3. تحقق من إنشاء فاتورة جديدة

**النتيجة المتوقعة:**
- ✅ يتم إنشاء فاتورة جديدة
- ✅ نوع الفاتورة: `playstation`
- ✅ رقم الطاولة: 5
- ✅ الجلسة مرتبطة بالفاتورة

---

### ✅ السيناريو 2: إضافة جهاز بلايستيشن آخر على نفس الطاولة

**الخطوات:**
1. بعد السيناريو 1، ابدأ جلسة PS2 على طاولة 5
2. تحقق من الفاتورة

**النتيجة المتوقعة:**
- ✅ **لا يتم إنشاء فاتورة جديدة**
- ✅ يتم إضافة الجلسة الجديدة لنفس الفاتورة
- ✅ الفاتورة تحتوي على جلستين (PS1 + PS2)

**كيفية التحقق:**
- افتح صفحة الفواتير
- اضغط على الفاتورة الخاصة بالطاولة 5
- تأكد من وجود جلستين في الفاتورة

---

### ✅ السيناريو 3: إضافة طلب كافيه على طاولة بها جلسة بلايستيشن

**الخطوات:**
1. بعد السيناريو 2، اذهب إلى صفحة الكافيه
2. أضف طلب (قهوة + شاي) على طاولة 5
3. تحقق من الفاتورة

**النتيجة المتوقعة:**
- ✅ **لا يتم إنشاء فاتورة جديدة**
- ✅ يتم إضافة الطلب لفاتورة البلايستيشن الموجودة
- ✅ الفاتورة تحتوي على:
  - جلسة PS1
  - جلسة PS2
  - طلب كافيه (قهوة + شاي)

**كيفية التحقق:**
- افتح صفحة الفواتير
- اضغط على الفاتورة الخاصة بالطاولة 5
- تأكد من وجود الجلسات والطلب في نفس الفاتورة

---

### ✅ السيناريو 4: بدء جلسة بلايستيشن على طاولة بها طلبات كافيه

**الخطوات:**
1. اذهب إلى صفحة الكافيه
2. أضف طلب (عصير + بيتزا) على طاولة 7
3. اذهب إلى صفحة الأجهزة
4. ابدأ جلسة PS3 على طاولة 7
5. تحقق من الفاتورة

**النتيجة المتوقعة:**
- ✅ **لا يتم إنشاء فاتورة جديدة**
- ✅ يتم إضافة الجلسة لفاتورة الكافيه الموجودة
- ✅ الفاتورة تحتوي على:
  - طلب كافيه (عصير + بيتزا)
  - جلسة PS3

---

### ✅ السيناريو 5: إضافة طلب على طاولة فارغة

**الخطوات:**
1. اذهب إلى صفحة الكافيه
2. أضف طلب (شاي + كيك) على طاولة 10
3. تحقق من إنشاء فاتورة جديدة

**النتيجة المتوقعة:**
- ✅ يتم إنشاء فاتورة جديدة
- ✅ نوع الفاتورة: `cafe`
- ✅ رقم الطاولة: 10
- ✅ الطلب مرتبط بالفاتورة

---

### ✅ السيناريو 6: عدة أجهزة بلايستيشن على نفس الطاولة

**الخطوات:**
1. ابدأ جلسة PS1 على طاولة 8
2. ابدأ جلسة PS2 على طاولة 8
3. ابدأ جلسة PS3 على طاولة 8
4. أضف طلب (3 قهوة) على طاولة 8
5. تحقق من الفاتورة

**النتيجة المتوقعة:**
- ✅ فاتورة واحدة فقط للطاولة 8
- ✅ الفاتورة تحتوي على:
  - جلسة PS1
  - جلسة PS2
  - جلسة PS3
  - طلب (3 قهوة)

---

## التحقق من Logs

افتح Console في المتصفح أو تحقق من logs الخادم للتأكد من:

### عند بدء جلسة على طاولة بها فاتورة:
```
✓ تم العثور على فاتورة موجودة للطاولة 5:
  billId: 507f1f77bcf86cd799439011
  billNumber: BILL-20240116-001
  billType: playstation
  status: draft
```

### عند إنشاء فاتورة جديدة:
```
✓ تم إنشاء فاتورة جديدة للجلسة:
  billId: 507f1f77bcf86cd799439012
  billNumber: BILL-20240116-002
  billType: playstation
  tableNumber: 7
```

### عند إضافة طلب لفاتورة موجودة:
```
✓ تم العثور على فاتورة موجودة للطاولة 5:
  billId: 507f1f77bcf86cd799439011
  billNumber: BILL-20240116-001
  billType: playstation
  status: draft
```

---

## اختبار API مباشر (اختياري)

### 1. بدء جلسة بلايستيشن
```bash
POST /api/sessions
{
  "deviceNumber": 1,
  "deviceName": "PS1",
  "deviceType": "playstation",
  "deviceId": "507f1f77bcf86cd799439011",
  "controllers": 2,
  "tableNumber": 5
}
```

### 2. إضافة طلب على نفس الطاولة
```bash
POST /api/orders
{
  "tableNumber": 5,
  "customerName": "عميل",
  "items": [
    {
      "menuItem": "507f1f77bcf86cd799439022",
      "quantity": 2
    }
  ]
}
```

### 3. التحقق من الفاتورة
```bash
GET /api/billing?tableNumber=5
```

**النتيجة المتوقعة:**
```json
{
  "success": true,
  "data": [
    {
      "_id": "507f1f77bcf86cd799439033",
      "billNumber": "BILL-20240116-001",
      "tableNumber": 5,
      "billType": "playstation",
      "sessions": [
        { "_id": "...", "deviceName": "PS1" }
      ],
      "orders": [
        { "_id": "...", "items": [...] }
      ],
      "total": 150.00
    }
  ]
}
```

---

## الأخطاء المحتملة وحلولها

### ❌ المشكلة: يتم إنشاء فاتورة جديدة بدلاً من استخدام الموجودة

**السبب المحتمل:**
- رقم الطاولة غير متطابق
- الفاتورة الموجودة في حالة `paid` أو `cancelled`

**الحل:**
- تأكد من أن رقم الطاولة متطابق تماماً
- تحقق من حالة الفاتورة الموجودة

---

### ❌ المشكلة: لا يتم إضافة الطلب/الجلسة للفاتورة

**السبب المحتمل:**
- خطأ في الربط بين الطلب/الجلسة والفاتورة
- مشكلة في حساب الإجمالي

**الحل:**
- تحقق من logs الخادم
- تأكد من أن `bill` field موجود في الطلب/الجلسة

---

## Checklist النهائي

- [ ] السيناريو 1: بدء جلسة على طاولة فارغة ✅
- [ ] السيناريو 2: إضافة جهاز آخر على نفس الطاولة ✅
- [ ] السيناريو 3: إضافة طلب على طاولة بها جلسة ✅
- [ ] السيناريو 4: بدء جلسة على طاولة بها طلب ✅
- [ ] السيناريو 5: إضافة طلب على طاولة فارغة ✅
- [ ] السيناريو 6: عدة أجهزة على نفس الطاولة ✅
- [ ] التحقق من Logs ✅
- [ ] اختبار API (اختياري) ✅

---

**ملاحظة:** هذه الاختبارات يدوية. يُنصح بإجرائها في بيئة التطوير قبل النشر للإنتاج.
