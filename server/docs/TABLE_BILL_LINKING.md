# ربط الفواتير بالطاولات - Table Bill Linking

## نظرة عامة

تم تحديث النظام ليدعم **فاتورة واحدة لكل طاولة** بغض النظر عن نوع الخدمة (بلايستيشن، كمبيوتر، أو كافيه).

## القاعدة الأساسية

**كل طاولة لها فاتورة واحدة فقط في نفس الوقت**

---

## السيناريوهات المدعومة

### 1️⃣ بدء جلسة بلايستيشن على طاولة فارغة

**الإجراء:**
- يتم البحث عن فاتورة غير مدفوعة على الطاولة
- إذا لم توجد، يتم إنشاء فاتورة جديدة من نوع `playstation`
- يتم ربط الجلسة بالفاتورة

**مثال:**
```
طاولة 5 → لا توجد فاتورة
↓
إنشاء فاتورة جديدة (Bill #123)
↓
بدء جلسة PS1 → ربطها بالفاتورة #123
```

---

### 2️⃣ إضافة جهاز بلايستيشن آخر على نفس الطاولة

**الإجراء:**
- يتم البحث عن فاتورة غير مدفوعة على الطاولة
- يتم ربط الجلسة الجديدة بنفس الفاتورة الموجودة
- **جميع أجهزة البلايستيشن على نفس الطاولة تشترك في فاتورة واحدة**

**مثال:**
```
طاولة 5 → فاتورة موجودة (Bill #123)
↓
بدء جلسة PS2 → ربطها بنفس الفاتورة #123
↓
بدء جلسة PS3 → ربطها بنفس الفاتورة #123
```

---

### 3️⃣ إضافة طلب كافيه على طاولة بها جلسة بلايستيشن

**الإجراء:**
- يتم البحث عن فاتورة غير مدفوعة على الطاولة
- يتم إضافة الطلب إلى فاتورة البلايستيشن الموجودة
- **الطلبات والجلسات تُجمع في فاتورة واحدة**

**مثال:**
```
طاولة 5 → فاتورة بلايستيشن موجودة (Bill #123)
↓
إضافة طلب (قهوة + شاي) → يُضاف لنفس الفاتورة #123
↓
الفاتورة #123 تحتوي على:
  - جلسة PS1
  - جلسة PS2
  - طلب كافيه (قهوة + شاي)
```

---

### 4️⃣ بدء جلسة بلايستيشن على طاولة بها طلبات كافيه

**الإجراء:**
- يتم البحث عن فاتورة غير مدفوعة على الطاولة
- يتم ربط جلسة البلايستيشن بفاتورة الكافيه الموجودة
- **نوع الفاتورة يبقى كما هو (cafe)، لكن تُضاف الجلسة**

**مثال:**
```
طاولة 7 → فاتورة كافيه موجودة (Bill #456)
↓
بدء جلسة PS1 → ربطها بنفس الفاتورة #456
↓
الفاتورة #456 تحتوي على:
  - طلب كافيه (عصير + بيتزا)
  - جلسة PS1
```

---

### 5️⃣ إضافة طلب على طاولة فارغة

**الإجراء:**
- يتم البحث عن فاتورة غير مدفوعة على الطاولة
- إذا لم توجد، يتم إنشاء فاتورة جديدة من نوع `cafe`
- يتم إضافة الطلب إلى الفاتورة

**مثال:**
```
طاولة 10 → لا توجد فاتورة
↓
إنشاء فاتورة جديدة (Bill #789)
↓
إضافة طلب (شاي + كيك) → يُضاف للفاتورة #789
```

---

## التغييرات التقنية

### 1. في `sessionController.js` - دالة `createSession`

**قبل التعديل:**
```javascript
// كان يُنشئ فاتورة جديدة دائماً
bill = await Bill.create(billData);
```

**بعد التعديل:**
```javascript
// يبحث عن فاتورة موجودة أولاً
if (tableNumber) {
    const existingBill = await Bill.findOne({
        tableNumber: tableNumber,
        organization: req.user.organization,
        status: { $in: ['draft', 'partial', 'overdue'] }
    }).sort({ createdAt: -1 });

    if (existingBill) {
        bill = existingBill; // استخدام الفاتورة الموجودة
    }
}

// إذا لم توجد فاتورة، أنشئ واحدة جديدة
if (!bill) {
    bill = await Bill.create(billData);
}
```

### 2. في `sessionController.js` - دالة `createSessionWithExistingBill`

**قبل التعديل:**
```javascript
// كان يمنع إضافة جلسة إذا كانت هناك جلسة نشطة
if (activeSessions.length > 0) {
    return res.status(400).json({
        message: "لا يمكن ربط جلسة بفاتورة بها جلسة نشطة"
    });
}
```

**بعد التعديل:**
```javascript
// السماح بإضافة جلسات متعددة على نفس الفاتورة
// (عدة أجهزة بلايستيشن على نفس الطاولة يمكن أن تكون لها نفس الفاتورة)
```

### 3. في `orderController.js` - دالة `createOrder`

**التحسين:**
```javascript
// البحث عن فاتورة غير مدفوعة للطاولة
// يشمل جميع أنواع الفواتير: playstation, computer, cafe
const existingBill = await Bill.findOne({
    tableNumber: tableNumber,
    organization: req.user.organization,
    status: { $in: ['draft', 'partial', 'overdue'] }
}).sort({ createdAt: -1 });
```

**إضافة Logging:**
```javascript
Logger.info(`✓ تم العثور على فاتورة موجودة للطاولة ${tableNumber}:`, {
    billId: existingBill._id,
    billNumber: existingBill.billNumber,
    billType: existingBill.billType,
    status: existingBill.status
});
```

---

## حالات الفواتير المدعومة

| حالة الفاتورة | الوصف | هل يمكن إضافة جلسات/طلبات؟ |
|---------------|-------|---------------------------|
| `draft` | مسودة (لم تُدفع بعد) | ✅ نعم |
| `partial` | مدفوعة جزئياً | ✅ نعم |
| `overdue` | متأخرة | ✅ نعم |
| `paid` | مدفوعة بالكامل | ❌ لا |
| `cancelled` | ملغية | ❌ لا |

---

## أنواع الفواتير

| نوع الفاتورة | متى يتم إنشاؤها | يمكن أن تحتوي على |
|--------------|-----------------|-------------------|
| `playstation` | عند بدء جلسة بلايستيشن على طاولة فارغة | جلسات بلايستيشن + طلبات كافيه |
| `computer` | عند بدء جلسة كمبيوتر على طاولة فارغة | جلسات كمبيوتر + طلبات كافيه |
| `cafe` | عند إضافة طلب على طاولة فارغة | طلبات كافيه + جلسات (أي نوع) |

**ملاحظة:** نوع الفاتورة (`billType`) يُحدد عند الإنشاء ولا يتغير، لكن يمكن إضافة أي نوع من الجلسات أو الطلبات لأي فاتورة.

---

## فوائد هذا النظام

### ✅ للعملاء
- فاتورة واحدة موحدة لكل طاولة
- سهولة الدفع (دفعة واحدة لكل شيء)
- وضوح في التكاليف

### ✅ للموظفين
- إدارة أسهل للفواتير
- تقليل الأخطاء
- سرعة في المعاملات

### ✅ للنظام
- تقليل عدد الفواتير المُنشأة
- سهولة التتبع والمراجعة
- تقارير أكثر دقة

---

## أمثلة عملية

### مثال 1: مجموعة أصدقاء على طاولة واحدة

```
الوقت 14:00 → بدء جلسة PS1 على طاولة 3
  ↓ إنشاء فاتورة #100 (playstation)

الوقت 14:15 → بدء جلسة PS2 على طاولة 3
  ↓ إضافة للفاتورة #100

الوقت 14:30 → طلب (2 قهوة + بيتزا) على طاولة 3
  ↓ إضافة للفاتورة #100

الوقت 16:00 → إنهاء الجلسات ودفع الفاتورة
  ↓ فاتورة واحدة تحتوي على:
      - جلسة PS1 (ساعتان)
      - جلسة PS2 (ساعة و45 دقيقة)
      - 2 قهوة
      - بيتزا
```

### مثال 2: عميل يبدأ بالطلب ثم يلعب

```
الوقت 15:00 → طلب (عصير + شاورما) على طاولة 7
  ↓ إنشاء فاتورة #200 (cafe)

الوقت 15:30 → بدء جلسة PS1 على طاولة 7
  ↓ إضافة للفاتورة #200

الوقت 17:00 → إنهاء الجلسة ودفع الفاتورة
  ↓ فاتورة واحدة تحتوي على:
      - عصير
      - شاورما
      - جلسة PS1 (ساعة ونصف)
```

---

## الخلاصة

✅ **فاتورة واحدة لكل طاولة**  
✅ **جميع الجلسات والطلبات على نفس الطاولة تُجمع في فاتورة واحدة**  
✅ **البحث التلقائي عن فواتير موجودة قبل إنشاء فواتير جديدة**  
✅ **دعم جلسات متعددة على نفس الفاتورة**  
✅ **Logging شامل لتتبع العمليات**

---

**تاريخ التحديث:** 2024  
**الإصدار:** 1.0
