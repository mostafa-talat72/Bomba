# Requirements Document

## Introduction

هذه الميزة تحسّن تجربة ربط جلسات البلايستيشن بالطاولات من خلال تحسين منطق طلب اسم العميل، إضافة إمكانية فك الربط، وتحسين منطق دمج الفواتير عند ربط جلسة نشطة بطاولة. حالياً، النظام يطلب اسم العميل دائماً عند إنهاء الجلسة بغض النظر عن حالة الربط بالطاولة، ولا يوجد خيار لفك الربط، كما أن منطق دمج الفواتير عند الربط يحتاج إلى تحسين لتجنب تكرار الفواتير.

## Glossary

- **System**: نظام Bomba لإدارة المقاهي والمطاعم وصالات الألعاب
- **PlayStation Session**: جلسة لعب على جهاز بلايستيشن مع تتبع الوقت والتكلفة
- **Active Session**: جلسة لا تزال قيد التشغيل ولم يتم إنهاؤها
- **Table Linking**: ربط الجلسة أو الفاتورة برقم طاولة محدد
- **Customer Name**: اسم العميل المرتبط بالجلسة أو الفاتورة
- **Bill**: فاتورة تحتوي على جلسات و/أو طلبات كافيه
- **Unpaid Bill**: فاتورة لم يتم دفعها بالكامل
- **Session Bill**: الفاتورة المرتبطة بجلسة معينة
- **Table Bill**: فاتورة مرتبطة بطاولة محددة
- **Bill Merging**: دمج فاتورتين في فاتورة واحدة

## Requirements

### Requirement 1

**User Story:** كمستخدم للنظام، أريد أن يطلب النظام اسم العميل فقط عندما تكون الجلسة غير مرتبطة بطاولة، حتى لا أضطر لإدخال معلومات غير ضرورية عندما تكون الجلسة مرتبطة بطاولة.

#### Acceptance Criteria

1. WHEN المستخدم ينهي جلسة بلايستيشن غير مرتبطة بطاولة، THEN THE System SHALL يعرض حقل إدخال اسم العميل كحقل إلزامي
2. WHEN المستخدم ينهي جلسة بلايستيشن مرتبطة بطاولة، THEN THE System SHALL لا يعرض حقل إدخال اسم العميل ويكمل عملية الإنهاء مباشرة
3. WHEN المستخدم يحاول إنهاء جلسة غير مرتبطة بطاولة بدون إدخال اسم العميل، THEN THE System SHALL يمنع الإنهاء ويعرض رسالة خطأ توضح أن اسم العميل مطلوب
4. WHEN المستخدم يدخل اسم العميل لجلسة غير مرتبطة بطاولة، THEN THE System SHALL يحفظ اسم العميل مع الجلسة والفاتورة المرتبطة بها
5. WHEN جلسة مرتبطة بطاولة يتم إنهاؤها، THEN THE System SHALL يحفظ الفاتورة بدون اسم عميل أو يستخدم اسم الطاولة كمرجع

### Requirement 2

**User Story:** كمستخدم للنظام، أريد أن أتمكن من فك ربط جلسة نشطة من طاولة، حتى أتمكن من تصحيح الأخطاء أو إعادة تنظيم الجلسات.

#### Acceptance Criteria

1. WHEN المستخدم يعرض جلسة نشطة مرتبطة بطاولة في صفحة البلايستيشن، THEN THE System SHALL يعرض زر "فك الربط" أو خيار لإلغاء الربط بالطاولة
2. WHEN المستخدم ينقر على زر "فك الربط"، THEN THE System SHALL يعرض نافذة تأكيد توضح أن الجلسة ستصبح غير مرتبطة بطاولة
3. WHEN المستخدم يؤكد فك الربط، THEN THE System SHALL يحدث حالة الجلسة لتصبح غير مرتبطة بطاولة ويحفظ التغيير في قاعدة البيانات
4. WHEN يتم فك ربط الجلسة بنجاح، THEN THE System SHALL يعرض رسالة تأكيد ويحدث واجهة المستخدم لإظهار أن الجلسة غير مرتبطة
5. WHEN يتم فك ربط جلسة من طاولة، THEN THE System SHALL يحتفظ بالفاتورة المرتبطة بالجلسة ولكن يزيل رقم الطاولة منها

### Requirement 3

**User Story:** كمستخدم للنظام، أريد أن يدمج النظام الفواتير بذكاء عند ربط جلسة نشطة بطاولة، حتى لا تتكرر الفواتير وتكون إدارة الدفع أسهل.

#### Acceptance Criteria

1. WHEN المستخدم يربط جلسة نشطة بطاولة تحتوي على فاتورة غير مدفوعة بالكامل، THEN THE System SHALL يضيف الجلسة إلى الفاتورة الموجودة على الطاولة
2. WHEN يتم إضافة جلسة إلى فاتورة موجودة على طاولة، THEN THE System SHALL يحذف الفاتورة القديمة المرتبطة بالجلسة من قاعدة البيانات
3. WHEN المستخدم يربط جلسة نشطة بطاولة لا تحتوي على فاتورة غير مدفوعة، THEN THE System SHALL ينقل الفاتورة المرتبطة بالجلسة إلى الطاولة المحددة
4. WHEN يتم نقل فاتورة جلسة إلى طاولة، THEN THE System SHALL يحدث رقم الطاولة في الفاتورة ويحفظ التغيير
5. WHEN يتم دمج فاتورة جلسة مع فاتورة طاولة موجودة، THEN THE System SHALL يحتفظ بجميع العناصر من كلا الفاتورتين في الفاتورة النهائية

### Requirement 4

**User Story:** كمستخدم للنظام، أريد أن تكون عملية دمج الفواتير آمنة وموثوقة، حتى لا أفقد أي بيانات مالية أو معلومات مهمة.

#### Acceptance Criteria

1. WHEN يتم دمج فاتورتين، THEN THE System SHALL يجمع إجمالي المبلغ المدفوع من كلا الفاتورتين في الفاتورة النهائية
2. WHEN يتم دمج فاتورتين، THEN THE System SHALL يحتفظ بجميع سجلات الدفع من كلا الفاتورتين
3. WHEN تفشل عملية دمج الفواتير، THEN THE System SHALL يعرض رسالة خطأ واضحة ويحتفظ بكلا الفاتورتين بدون تغيير
4. WHEN يتم حذف فاتورة قديمة بعد الدمج، THEN THE System SHALL يتحقق من نجاح عملية الدمج أولاً قبل الحذف
5. THE System SHALL يسجل عملية دمج الفواتير في سجل النظام لأغراض التدقيق والمراجعة

### Requirement 5

**User Story:** كمستخدم للنظام، أريد أن تكون واجهة المستخدم واضحة ومتسقة عند التعامل مع ربط الجلسات بالطاولات، حتى أتمكن من استخدام النظام بكفاءة.

#### Acceptance Criteria

1. WHEN المستخدم يعرض جلسة نشطة في صفحة البلايستيشن، THEN THE System SHALL يعرض بوضوح ما إذا كانت الجلسة مرتبطة بطاولة أم لا
2. WHEN جلسة مرتبطة بطاولة، THEN THE System SHALL يعرض رقم الطاولة بشكل واضح بجانب معلومات الجلسة
3. WHEN المستخدم يحاول ربط جلسة بطاولة، THEN THE System SHALL يعرض نافذة منبثقة تحتوي على قائمة منسدلة لاختيار الطاولة
4. WHEN يتم ربط أو فك ربط جلسة بنجاح، THEN THE System SHALL يحدث واجهة المستخدم فوراً لإظهار التغيير
5. THE System SHALL يستخدم رموز وألوان مميزة لتوضيح حالة ربط الجلسة بالطاولة (مثل أيقونة طاولة للجلسات المرتبطة)

### Requirement 6

**User Story:** كمستخدم للنظام، أريد أن يتعامل النظام مع الحالات الاستثنائية بشكل صحيح، حتى لا أواجه أخطاء غير متوقعة.

#### Acceptance Criteria

1. WHEN المستخدم يحاول ربط جلسة بطاولة غير موجودة، THEN THE System SHALL يعرض رسالة خطأ ويمنع عملية الربط
2. WHEN المستخدم يحاول فك ربط جلسة غير مرتبطة بطاولة، THEN THE System SHALL يعرض رسالة توضح أن الجلسة غير مرتبطة أصلاً
3. WHEN يحدث خطأ في الاتصال بقاعدة البيانات أثناء دمج الفواتير، THEN THE System SHALL يعرض رسالة خطأ ويحتفظ بالحالة السابقة
4. WHEN المستخدم يحاول ربط جلسة منتهية بطاولة، THEN THE System SHALL يسمح بالربط ولكن يحدث الفاتورة فقط بدون تأثير على الجلسة
5. THE System SHALL يتحقق من صحة جميع المدخلات قبل تنفيذ أي عملية ربط أو فك ربط أو دمج

### Requirement 7

**User Story:** كمستخدم للنظام، أريد أن يحافظ النظام على تناسق البيانات عند ربط الجلسات بالطاولات، حتى تكون التقارير والإحصائيات دقيقة.

#### Acceptance Criteria

1. WHEN يتم ربط جلسة بطاولة، THEN THE System SHALL يحدث حالة الطاولة لتعكس وجود جلسة نشطة عليها
2. WHEN يتم فك ربط جلسة من طاولة، THEN THE System SHALL يحدث حالة الطاولة بناءً على وجود فواتير أو جلسات أخرى
3. WHEN يتم دمج فاتورتين، THEN THE System SHALL يحدث جميع المراجع في قاعدة البيانات للإشارة إلى الفاتورة النهائية
4. THE System SHALL يضمن أن كل جلسة نشطة مرتبطة بفاتورة واحدة فقط في أي وقت
5. THE System SHALL يضمن أن كل فاتورة غير مدفوعة مرتبطة بطاولة واحدة فقط أو بدون طاولة

