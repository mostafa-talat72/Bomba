# Implementation Plan

## ๐ Implementation Status Summary

### โ Completed Features
- **Customer Name Logic**: ุงููุธุงู ูุทูุจ ุงุณู ุงูุนููู ููุท ุนูุฏ ุฅููุงุก ุฌูุณุฉ ุบูุฑ ูุฑุชุจุทุฉ ุจุทุงููุฉ
- **Session End UI**: ูุงุฌูุฉ ุฅููุงุก ุงูุฌูุณุฉ ุชุนุฑุถ ุญูู ุงุณู ุงูุนููู ุจุดูู ุดุฑุทู
- **Unlink Functionality**: ุฅููุงููุฉ ูู ุฑุจุท ุฌูุณุฉ ูู ุทุงููุฉ ูุน ูุนุงูุฌุฉ ุงููุงุชูุฑุฉ ุจุดูู ุตุญูุญ
- **UI Improvements**: ุงูุฃุฒุฑุงุฑ ุชุธูุฑ ุจูุงุกู ุนูู ุญุงูุฉ ุงูุฌูุณุฉ (ูุฑุชุจุทุฉ/ุบูุฑ ูุฑุชุจุทุฉ)

### โ๏ธ ุงูููุงู ุงููุชุจููุฉ - ุฏูุฌ ุงูููุงุชูุฑ ุงูุฐูู

**ุงููุดููุฉ ุงูุญุงููุฉ:**
ุนูุฏ ุฑุจุท ุฌูุณุฉ ูุดุทุฉ ุจุทุงููุฉุ ุงููุธุงู ูููู ููุท ุจุชุญุฏูุซ ุฑูู ุงูุทุงููุฉ ูู ูุงุชูุฑุฉ ุงูุฌูุณุฉ. ุฅุฐุง ูุงูุช ุงูุทุงููุฉ ุชุญุชูู ุนูู ูุงุชูุฑุฉ ููุฌูุฏุฉุ ููุชูู ุงูุฃูุฑ ุจูุงุชูุฑุชูู ูููุตูุชูู.

**ุงูุณููู ุงููุทููุจ:**
1. **ุฅุฐุง ูุงูุช ุงูุทุงููุฉ ุชุญุชูู ุนูู ูุงุชูุฑุฉ ุบูุฑ ูุฏููุนุฉ:**
   - ุฏูุฌ ูุงุชูุฑุฉ ุงูุฌูุณุฉ ูุน ูุงุชูุฑุฉ ุงูุทุงููุฉ ุงูููุฌูุฏุฉ
   - ููู ุฌููุน ุงูุฌูุณุงุช ูุงูุทูุจุงุช ูุงููุฏููุนุงุช
   - ุญุฐู ูุงุชูุฑุฉ ุงูุฌูุณุฉ ุงููุฏููุฉ
   
2. **ุฅุฐุง ูู ุชูู ุงูุทุงููุฉ ุชุญุชูู ุนูู ูุงุชูุฑุฉ:**
   - ููู ูุงุชูุฑุฉ ุงูุฌูุณุฉ ุฅูู ุงูุทุงููุฉ ุงููุญุฏุฏุฉ

**ุงูููุงู ุงููุทููุจุฉ:**
- Task 1: ุฅูุดุงุก endpoint ุฌุฏูุฏ `linkSessionToTable` ูู Backend
- Task 2: ุฅูุดุงุก ุฏุงูุฉ ูุณุงุนุฏุฉ `mergeBills` ูุฏูุฌ ุงูููุงุชูุฑ
- Task 3: ุฅุถุงูุฉ route ููู endpoint ุงูุฌุฏูุฏ
- Task 4: ุชุญุฏูุซ Frontend ูุงุณุชุฎุฏุงู ุงูู endpoint ุงูุฌุฏูุฏ
- Task 5: ุฅุถุงูุฉ ุฏุงูุฉ ูู API service

---

- [x] 1. Backend: ุฅูุดุงุก endpoint ูุฑุจุท ุฌูุณุฉ ุจุทุงููุฉ ูุน ุฏูุฌ ุงูููุงุชูุฑ


  - ุฅูุดุงุก ุฏุงูุฉ `linkSessionToTable` ุฌุฏูุฏุฉ ูู `server/controllers/sessionController.js`
  - ุงูุจุญุซ ุนู ูุงุชูุฑุฉ ููุฌูุฏุฉ ุบูุฑ ูุฏููุนุฉ ุนูู ุงูุทุงููุฉ ุงููุญุฏุฏุฉ ุจุงุณุชุฎุฏุงู:
    ```javascript
    const existingTableBill = await Bill.findOne({
      table: tableId,
      organization: req.user.organization,
      status: { $in: ['draft', 'partial', 'overdue'] }
    }).sort({ createdAt: -1 });
    ```
  - ุฅุฐุง ูุฌุฏุช ูุงุชูุฑุฉ ุนูู ุงูุทุงููุฉุ ุงุณุชุฏุนุงุก ุฏุงูุฉ `mergeBills` ูุฏูุฌ ุงูููุงุชูุฑ
  - ุฅุฐุง ูู ุชูุฌุฏ ูุงุชูุฑุฉุ ููู ูุงุชูุฑุฉ ุงูุฌูุณุฉ ุฅูู ุงูุทุงููุฉ ุจุชุญุฏูุซ `sessionBill.table = tableId`
  - ุงุณุชุฎุฏุงู MongoDB transactions ูุถูุงู atomicity
  - ุฅุฑุฌุงุน ุงุณุชุฌุงุจุฉ ูุฌุงุญ ูุน ุงููุงุชูุฑุฉ ุงูููุงุฆูุฉ
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.1 ุฅูุดุงุก ุฏุงูุฉ ูุณุงุนุฏุฉ `mergeBills` ูุฏูุฌ ุงูููุงุชูุฑ

  - ุฅูุดุงุก ุฏุงูุฉ `async function mergeBills(sourceBill, targetBill, session)` ูู ููุณ ุงูููู
  - ููู ุงูุฌูุณุฉ ุฅูู ุงููุงุชูุฑุฉ ุงููุณุชูุฏูุฉ: `targetBill.sessions.push(session._id)`
  - ููู ุฌููุน ุงูุทูุจุงุช ูู ุงููุงุชูุฑุฉ ุงููุตุฏุฑ: `targetBill.orders.push(...sourceBill.orders)`
  - ููู ุฌููุน ุณุฌูุงุช ุงูุฏูุน: `targetBill.payments.push(...sourceBill.payments)`
  - ุฌูุน ุงููุจุงูุบ ุงููุฏููุนุฉ: `targetBill.paid += sourceBill.paid || 0`
  - ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงูู: `await targetBill.calculateSubtotal()`
  - ุญูุธ ุงููุงุชูุฑุฉ ุงููุณุชูุฏูุฉ: `await targetBill.save()`
  - ุชุญุฏูุซ ูุฑุฌุน ุงููุงุชูุฑุฉ ูู ุงูุฌูุณุฉ: `session.bill = targetBill._id; await session.save()`
  - ุญุฐู ุงููุงุชูุฑุฉ ุงููุตุฏุฑ: `await Bill.findByIdAndDelete(sourceBill._id)`
  - ุชุณุฌูู ุนูููุฉ ุงูุฏูุฌ: `Logger.info('Merged bills: ...')`
  - _Requirements: 3.1, 3.2, 3.5, 4.1, 4.2, 4.4, 4.5_

- [ ]* 1.2 ูุชุงุจุฉ ุงุฎุชุจุงุฑ ุฎุงุตูุฉ ูุฏูุฌ ุงูููุงุชูุฑ ูุน ุงูุชูุธูู
  - **Property 6: Bill merging with cleanup**
  - **Validates: Requirements 3.1, 3.2**

- [ ]* 1.3 ูุชุงุจุฉ ุงุฎุชุจุงุฑ ุฎุงุตูุฉ ูููู ุงููุงุชูุฑุฉ ุฅูู ุทุงููุฉ
  - **Property 7: Bill transfer to table**
  - **Validates: Requirements 3.3, 3.4**

- [ ]* 1.4 ูุชุงุจุฉ ุงุฎุชุจุงุฑ ุฎุงุตูุฉ ูุงูุชูุงู ุฏูุฌ ุงูููุงุชูุฑ
  - **Property 8: Bill merging completeness**
  - **Validates: Requirements 3.5**

- [ ]* 1.5 ูุชุงุจุฉ ุงุฎุชุจุงุฑ ุฎุงุตูุฉ ูุฌูุน ุงููุฏููุนุงุช ุฃุซูุงุก ุงูุฏูุฌ
  - **Property 9: Payment aggregation during merge**
  - **Validates: Requirements 4.1**

- [x] 2. Backend: ุฅุถุงูุฉ route ููู endpoint ุงูุฌุฏูุฏ


  - ุฅุถุงูุฉ route ูู `server/routes/sessionRoutes.js`
  - `PUT /api/sessions/:sessionId/link-table`
  - ุฑุจุท ุงูู route ุจุฏุงูุฉ `linkSessionToTable` ูู controller
  - ุฅุถุงูุฉ authorization middleware ุงูููุงุณุจ (auth)
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 3. Frontend: ุชุญุฏูุซ ุฏุงูุฉ ุฑุจุท ุงูุฌูุณุฉ ุจุทุงููุฉ


  - ุชุนุฏูู ุฏุงูุฉ `handleLinkTableToSession` ูู `src/pages/PlayStation.tsx`
  - ุงุณุชุจุฏุงู ุงูููุฏ ุงูุญุงูู ุงูุฐู ูุญุฏุซ ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ
  - ุงุณุชุฎุฏุงู ุงูู endpoint ุงูุฌุฏูุฏ: `await api.linkSessionToTable(session._id, selectedTableId)`
  - ูุนุงูุฌุฉ ุงูุงุณุชุฌุงุจุฉ ูุนุฑุถ ุฑุณุงุฆู ุงููุฌุงุญ/ุงููุดู ุงูููุงุณุจุฉ
  - ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฌูุณุงุช ุจุนุฏ ูุฌุงุญ ุงูุนูููุฉ: `fetchSessions()`
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 4. Frontend: ุฅุถุงูุฉ ุฏุงูุฉ ูู API service


  - ุฅุถุงูุฉ ุฏุงูุฉ `linkSessionToTable` ูู `src/services/api.ts`
  - ุงุณุชูุจุงู `sessionId` ู `tableId` ููุนุงููุงุช
  - ุฅุฑุณุงู ุทูุจ PUT ุฅูู `/api/sessions/${sessionId}/link-table`
  - ุฅุฑุณุงู `{ tableId }` ูู body
  - ุฅุฑุฌุงุน ุงูุงุณุชุฌุงุจุฉ: `return response.data`
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5. Checkpoint - ุงุฎุชุจุงุฑ ุฏูุฌ ุงูููุงุชูุฑ



  - ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู 1: ุฑุจุท ุฌูุณุฉ ุจุทุงููุฉ ุชุญุชูู ุนูู ูุงุชูุฑุฉ ููุฌูุฏุฉ
  - ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู 2: ุฑุจุท ุฌูุณุฉ ุจุทุงููุฉ ูุงุฑุบุฉ
  - ุงูุชุฃูุฏ ูู ุฏูุฌ ุงูููุงุชูุฑ ุจุดูู ุตุญูุญ
  - ุงูุชุฃูุฏ ูู ุญุฐู ุงููุงุชูุฑุฉ ุงููุฏููุฉ
  - ุงูุชุฃูุฏ ูู ููู ุฌููุน ุงูุจูุงูุงุช (ุฌูุณุงุชุ ุทูุจุงุชุ ูุฏููุนุงุช)
  - ูุฑุงุฌุนุฉ ุฃู ูุดุงูู ูุน ุงููุณุชุฎุฏู ุฅุฐุง ุธูุฑุช

