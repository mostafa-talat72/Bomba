# Requirements Document

## Introduction

هذه الميزة تهدف إلى إصلاح مشكلة في نظام ربط الطلبات بالطاولات والفواتير. حالياً، توجد حالات حيث تظهر طلبات في صفحة الطلبات ولكن الطاولة المرتبطة بها تظهر كفارغة (غير محجوزة)، وأيضاً لا تظهر الفواتير المرتبطة بهذه الطلبات في صفحة الفواتير. هذا يسبب تناقضاً في البيانات ويؤثر على دقة النظام.

## Glossary

- **System**: نظام Bomba لإدارة المقاهي والمطاعم
- **Order**: طلب كافيه يحتوي على أصناف من القائمة
- **Table**: طاولة في المقهى أو المطعم
- **Bill**: فاتورة تحتوي على طلبات و/أو جلسات
- **Table Status**: حالة الطاولة (available/occupied/reserved)
- **Unpaid Bill**: فاتورة لم يتم دفعها بالكامل (draft/partial/overdue)
- **Order-Table Linking**: ربط الطلب برقم طاولة محدد
- **Order-Bill Linking**: ربط الطلب بفاتورة محددة

## Requirements

### Requirement 1

**User Story:** كمستخدم للنظام، أريد أن يتم ربط كل طلب بفاتورة تلقائياً عند إنشائه، حتى تظهر جميع الطلبات في صفحة الفواتير بشكل صحيح.

#### Acceptance Criteria

1. WHEN المستخدم ينشئ طلباً جديداً مرتبطاً بطاولة، THEN THE System SHALL يبحث عن فاتورة غير مدفوعة موجودة لهذه الطاولة
2. WHEN يتم العثور على فاتورة غير مدفوعة للطاولة، THEN THE System SHALL يضيف الطلب إلى هذه الفاتورة الموجودة
3. WHEN لا يتم العثور على فاتورة غير مدفوعة للطاولة، THEN THE System SHALL ينشئ فاتورة جديدة ويضيف الطلب إليها
4. WHEN يتم إنشاء طلب بدون طاولة، THEN THE System SHALL ينشئ فاتورة جديدة للطلب
5. THE System SHALL يحفظ معرف الفاتورة في حقل bill الخاص بالطلب

### Requirement 2

**User Story:** كمستخدم للنظام، أريد أن تتحدث حالة الطاولة تلقائياً عند إنشاء طلب لها، حتى تظهر الطاولة كمحجوزة في واجهة المستخدم.

#### Acceptance Criteria

1. WHEN يتم إنشاء طلب مرتبط بطاولة، THEN THE System SHALL يحدث حالة الطاولة إلى 'occupied'
2. WHEN يتم إنشاء فاتورة لطاولة، THEN THE System SHALL يحدث حالة الطاولة إلى 'occupied'
3. WHEN يتم دفع جميع فواتير الطاولة بالكامل، THEN THE System SHALL يحدث حالة الطاولة إلى 'available'
4. WHEN يتم حذف آخر طلب غير مدفوع من طاولة، THEN THE System SHALL يحدث حالة الطاولة إلى 'available'
5. THE System SHALL يتحقق من حالة الطاولة بناءً على وجود فواتير غير مدفوعة

### Requirement 3

**User Story:** كمستخدم للنظام، أريد أن تظهر جميع الفواتير المرتبطة بالطلبات في صفحة الفواتير، حتى أتمكن من إدارة المدفوعات بشكل صحيح.

#### Acceptance Criteria

1. WHEN المستخدم يفتح صفحة الفواتير، THEN THE System SHALL يعرض جميع الفواتير التي تحتوي على طلبات
2. WHEN فاتورة تحتوي على طلبات مرتبطة بطاولة، THEN THE System SHALL يعرض رقم الطاولة في الفاتورة
3. WHEN فاتورة تحتوي على طلبات غير مرتبطة بطاولة، THEN THE System SHALL يعرض اسم العميل أو "عميل" كافتراضي
4. THE System SHALL يحسب إجمالي الفاتورة بناءً على جميع الطلبات المرتبطة بها
5. THE System SHALL يعرض حالة الفاتورة بشكل صحيح (draft/partial/paid/overdue)

### Requirement 4

**User Story:** كمستخدم للنظام، أريد أن يتم تحديث الفاتورة تلقائياً عند تعديل أو حذف طلب، حتى تبقى البيانات متسقة.

#### Acceptance Criteria

1. WHEN يتم تعديل طلب مرتبط بفاتورة، THEN THE System SHALL يعيد حساب إجمالي الفاتورة
2. WHEN يتم حذف طلب من فاتورة، THEN THE System SHALL يزيل الطلب من قائمة طلبات الفاتورة
3. WHEN يتم حذف آخر طلب من فاتورة، THEN THE System SHALL يحذف الفاتورة أو يحدث حالتها بناءً على وجود جلسات
4. WHEN يتم تحديث عناصر الطلب، THEN THE System SHALL يعيد حساب تكلفة الطلب وإجمالي الفاتورة
5. THE System SHALL يحدث حالة الفاتورة بناءً على المبلغ المدفوع والمتبقي

### Requirement 5

**User Story:** كمستخدم للنظام، أريد أن تكون عملية ربط الطلبات بالفواتير والطاولات موثوقة، حتى لا أواجه أخطاء أو تناقضات في البيانات.

#### Acceptance Criteria

1. WHEN يتم إنشاء طلب، THEN THE System SHALL يتحقق من صحة معرف الطاولة قبل الربط
2. WHEN يتم إنشاء فاتورة، THEN THE System SHALL يتحقق من عدم وجود فاتورة مكررة لنفس الطاولة
3. WHEN يحدث خطأ أثناء إنشاء الطلب أو الفاتورة، THEN THE System SHALL يتراجع عن جميع التغييرات
4. THE System SHALL يسجل جميع عمليات الربط في سجل النظام للتدقيق
5. THE System SHALL يعرض رسائل خطأ واضحة عند فشل عملية الربط

### Requirement 6

**User Story:** كمستخدم للنظام، أريد أن تتزامن البيانات بين صفحة الطلبات وصفحة الفواتير، حتى أرى نفس المعلومات في كلا الصفحتين.

#### Acceptance Criteria

1. WHEN يتم إنشاء طلب في صفحة الكافيه، THEN THE System SHALL يحدث صفحة الفواتير تلقائياً عبر Socket.IO
2. WHEN يتم دفع فاتورة في صفحة الفواتير، THEN THE System SHALL يحدث حالة الطاولة في صفحة الكافيه
3. WHEN يتم حذف طلب، THEN THE System SHALL يحدث كلاً من صفحة الطلبات وصفحة الفواتير
4. THE System SHALL يستخدم Socket.IO لإرسال تحديثات فورية لجميع المستخدمين المتصلين
5. THE System SHALL يحدث واجهة المستخدم فوراً عند استلام تحديثات عبر Socket.IO

### Requirement 7

**User Story:** كمستخدم للنظام، أريد أن يتعامل النظام مع الحالات الاستثنائية بشكل صحيح، حتى لا تحدث مشاكل في البيانات.

#### Acceptance Criteria

1. WHEN يتم إنشاء طلب لطاولة غير موجودة، THEN THE System SHALL يعرض رسالة خطأ ويمنع إنشاء الطلب
2. WHEN يحدث خطأ في الاتصال بقاعدة البيانات، THEN THE System SHALL يعرض رسالة خطأ ويحتفظ بالحالة السابقة
3. WHEN يتم إنشاء طلب بدون عناصر، THEN THE System SHALL يعرض رسالة خطأ ويمنع إنشاء الطلب
4. WHEN يتم حذف طاولة لها طلبات نشطة، THEN THE System SHALL يمنع الحذف ويعرض رسالة تحذير
5. THE System SHALL يتحقق من صحة جميع المدخلات قبل تنفيذ أي عملية

### Requirement 8

**User Story:** كمستخدم للنظام، أريد أن يحافظ النظام على تناسق البيانات بين الطلبات والفواتير والطاولات، حتى تكون التقارير دقيقة.

#### Acceptance Criteria

1. THE System SHALL يضمن أن كل طلب مرتبط بفاتورة واحدة فقط في أي وقت
2. THE System SHALL يضمن أن كل فاتورة مرتبطة بطاولة واحدة فقط أو بدون طاولة
3. THE System SHALL يضمن أن حالة الطاولة تعكس بدقة وجود فواتير غير مدفوعة
4. THE System SHALL يضمن أن إجمالي الفاتورة يساوي مجموع جميع الطلبات والجلسات المرتبطة بها
5. THE System SHALL يضمن أن حذف طلب لا يؤدي إلى فواتير يتيمة أو بيانات غير متسقة
