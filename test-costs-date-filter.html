<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .quick-dates {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .quick-date-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .quick-date-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</h1>
        <p>Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</p>

        <div class="test-section">
            <h3>ğŸ“… Ø§Ø®ØªØ¨Ø§Ø± ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</h3>
            
            <div class="form-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="dateFrom" />
            </div>
            
            <div class="form-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="dateTo" />
            </div>

            <div class="quick-dates">
                <button class="quick-date-btn" onclick="setToday()">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="quick-date-btn" onclick="setThisWeek()">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="quick-date-btn" onclick="setThisMonth()">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
                <button class="quick-date-btn" onclick="setLastMonth()">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</button>
                <button class="quick-date-btn" onclick="clearDates()">Ù…Ø³Ø­</button>
            </div>

            <div class="form-group">
                <label>ÙØ¦Ø© Ø§Ù„ØªÙƒÙ„ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <select id="category">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒÙ„ÙØ©:</label>
                <select id="status">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="pending">Ù…Ø¹Ù„Ù‚</option>
                    <option value="partially_paid">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                    <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                    <option value="overdue">Ù…ØªØ£Ø®Ø±</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø­Ø« (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ±Ø¯..." />
            </div>

            <button onclick="testDateFilter()">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø©</button>
            <button onclick="testAllCosts()">ğŸ“‹ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</button>
        </div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = '';

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        async function autoLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@bomba.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                    await loadCategories();
                } else {
                    console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/cost-categories`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const categories = await response.json();
                    const categorySelect = document.getElementById('category');
                    
                    const categoriesData = Array.isArray(categories) ? categories : (categories.data || []);
                    
                    categoriesData.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category._id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª:', error);
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        async function testDateFilter() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const category = document.getElementById('category').value;
            const status = document.getElementById('status').value;
            const search = document.getElementById('search').value;

            const params = new URLSearchParams();
            
            if (dateFrom) params.append('dateFrom', dateFrom);
            if (dateTo) params.append('dateTo', dateTo);
            if (category) params.append('category', category);
            if (status !== 'all') params.append('status', status);
            if (search.trim()) params.append('search', search.trim());

            showResults(`ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø©...
Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:
${params.toString() || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± Ù…Ø­Ø¯Ø¯Ø©'}`);

            try {
                const response = await fetch(`${API_BASE}/costs?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const costs = Array.isArray(data) ? data : (data.data || []);
                    
                    showResults(`âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!
                    
ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
- Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: ${costs.length}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: ${data.totalAmount || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¬Ù†ÙŠÙ‡

ğŸ” Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:
${dateFrom ? `- Ù…Ù† ØªØ§Ø±ÙŠØ®: ${new Date(dateFrom).toLocaleDateString('ar-EG')}` : ''}
${dateTo ? `- Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®: ${new Date(dateTo).toLocaleDateString('ar-EG')}` : ''}
${category ? `- Ø§Ù„ÙØ¦Ø©: ${document.getElementById('category').selectedOptions[0].text}` : ''}
${status !== 'all' ? `- Ø§Ù„Ø­Ø§Ù„Ø©: ${getStatusText(status)}` : ''}
${search ? `- Ø§Ù„Ø¨Ø­Ø«: "${search}"` : ''}

ğŸ“‹ Ø£ÙˆÙ„ 3 ØªÙƒØ§Ù„ÙŠÙ:
${costs.slice(0, 3).map((cost, index) => `
${index + 1}. ${cost.description}
   - Ø§Ù„Ù…Ø¨Ù„Øº: ${cost.amount} Ø¬Ù†ÙŠÙ‡
   - Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${cost.paidAmount} Ø¬Ù†ÙŠÙ‡
   - Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(cost.date).toLocaleDateString('ar-EG')}
   - Ø§Ù„Ø­Ø§Ù„Ø©: ${getStatusText(cost.status)}
   - Ø§Ù„ÙØ¦Ø©: ${cost.category?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
`).join('')}

ğŸŒ Ø±Ø§Ø¨Ø· API Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
${API_BASE}/costs?${params.toString()}`, 'success');

                } else {
                    showResults(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!
                    
Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:
${data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}

ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:
${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResults(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©!
                
ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:
${error.message}

ğŸ”§ ØªØ£ÙƒØ¯ Ù…Ù†:
- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5000
- ØµØ­Ø© Ø±Ø§Ø¨Ø· API
- Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª`, 'error');
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
        async function testAllCosts() {
            showResults('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ...');

            try {
                const response = await fetch(`${API_BASE}/costs`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const costs = Array.isArray(data) ? data : (data.data || []);
                    
                    showResults(`âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­!
                    
ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ: ${costs.length}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: ${data.totalAmount || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø¬Ù†ÙŠÙ‡

ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª:
- Ù…Ø¹Ù„Ù‚: ${costs.filter(c => c.status === 'pending').length}
- Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹: ${costs.filter(c => c.status === 'partially_paid').length}
- Ù…Ø¯ÙÙˆØ¹: ${costs.filter(c => c.status === 'paid').length}
- Ù…ØªØ£Ø®Ø±: ${costs.filter(c => c.status === 'overdue').length}

ğŸ“… Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®:
${costs.length > 0 ? `
- Ø£Ù‚Ø¯Ù… ØªÙƒÙ„ÙØ©: ${new Date(Math.min(...costs.map(c => new Date(c.date)))).toLocaleDateString('ar-EG')}
- Ø£Ø­Ø¯Ø« ØªÙƒÙ„ÙØ©: ${new Date(Math.max(...costs.map(c => new Date(c.date)))).toLocaleDateString('ar-EG')}
` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒØ§Ù„ÙŠÙ'}`, 'success');

                } else {
                    showResults(`âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ!
                    
${data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 'error');
                }
            } catch (error) {
                showResults(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${error.message}`, 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function showResults(message, type = '') {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = message;
            resultsDiv.style.display = 'block';
            resultsDiv.className = `results ${type}`;
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø©
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ù…Ø¹Ù„Ù‚',
                'partially_paid': 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹',
                'paid': 'Ù…Ø¯ÙÙˆØ¹',
                'overdue': 'Ù…ØªØ£Ø®Ø±',
                'cancelled': 'Ù…Ù„ØºÙŠ'
            };
            return statusMap[status] || status;
        }

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
        }

        function setThisWeek() {
            const today = new Date();
            const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
            const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            
            document.getElementById('dateFrom').value = weekStart.toISOString().split('T')[0];
            document.getElementById('dateTo').value = weekEnd.toISOString().split('T')[0];
        }

        function setThisMonth() {
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('dateFrom').value = monthStart.toISOString().split('T')[0];
            document.getElementById('dateTo').value = monthEnd.toISOString().split('T')[0];
        }

        function setLastMonth() {
            const today = new Date();
            const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            
            document.getElementById('dateFrom').value = lastMonthStart.toISOString().split('T')[0];
            document.getElementById('dateTo').value = lastMonthEnd.toISOString().split('T')[0];
        }

        function clearDates() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = autoLogin;
    </script>
</body>
</html>