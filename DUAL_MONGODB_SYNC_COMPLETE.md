# Dual MongoDB Sync - ูุธุงู ุงููุฒุงููุฉ ุงููุฒุฏูุฌ โ

## ๐ ุชู ุงูุชูููุฐ ุจูุฌุงุญ!

ุชู ุชุทุจูู ูุธุงู ุงููุฒุงููุฉ ุงููุฒุฏูุฌ ุจูุฌุงุญ ูู ุชุทุจูู Bomba. ุงููุธุงู ุงูุขู ูุนูู ุนูู MongoDB ูุญูู ููุณุฑุนุฉ ูุน ูุฒุงููุฉ ุชููุงุฆูุฉ ุฅูู MongoDB Atlas ููุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุญุงุจูุฉ.

---

## ๐ ูุง ุชู ุชูููุฐู

### โ ุงูููููุงุช ุงูุฃุณุงุณูุฉ

#### 1. **DualDatabaseManager** (`server/config/dualDatabaseManager.js`)
- ุฅุฏุงุฑุฉ ุงุชุตุงููู ูููุตููู (Local + Atlas)
- ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ ูุน exponential backoff
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- Event handlers ูููุง ุงูุงุชุตุงููู

#### 2. **SyncQueueManager** (`server/services/sync/syncQueueManager.js`)
- ูุงุฆูุฉ ุงูุชุธุงุฑ ุจุญุฏ ุฃูุตู 10,000 ุนูููุฉ
- Persistence ุชููุงุฆู ุฅูู ุงููุฑุต
- ุฅุญุตุงุฆูุงุช ููุตูุฉ
- ุญุณุงุจ Sync lag

#### 3. **SyncWorker** (`server/services/sync/syncWorker.js`)
- ูุนุงูุฌุฉ ุงูุนูููุงุช ูู ุงูุฎูููุฉ
- Retry logic ูุน exponential backoff (1s, 5s, 15s, 30s, 60s)
- ุชูููุฐ Insert/Update/Delete ุนูู Atlas
- Start/Stop/Pause/Resume controls

#### 4. **SyncMiddleware** (`server/middleware/sync/syncMiddleware.js`)
- Mongoose post-hooks ุดูุงูุฉ
- ุงุนุชุฑุงุถ ุฌููุน ุนูููุงุช ุงูู CRUD
- ุฏุนู ุงุณุชุจุนุงุฏ collections ูุญุฏุฏุฉ
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุจุฏูู ุชุนุทูู ุงูุนูููุงุช

#### 5. **SyncMonitor** (`server/services/sync/syncMonitor.js`)
- ุชุชุจุน ุฌููุน ุงูุนูููุงุช (ูุฌุงุญ/ูุดู)
- Health checks ุดุงููุฉ
- ุชูุงุฑูุฑ ููุตูุฉ ูุน ุชูุตูุงุช
- ุชุญุฐูุฑุงุช ุชููุงุฆูุฉ

#### 6. **API Endpoints** (`server/routes/syncRoutes.js`)
- 10 endpoints ูููุฑุงูุจุฉ ูุงูุชุญูู
- ุญูุงูุฉ ุจู authentication ู authorization
- ุชูุซูู ูุงูู

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุชุดุบูู ุงูุฃุณุงุณู

1. **ุชุฃูุฏ ูู ุชุดุบูู MongoDB ุงููุญูู:**
```bash
mongod
```

2. **ุชุญุฏูุซ ููู .env:**
```env
# ุชู ุฅุถุงูุฉ ูุฐู ุงููุชุบูุฑุงุช ุชููุงุฆูุงู
SYNC_ENABLED=true
MONGODB_LOCAL_URI=mongodb://localhost:27017/bomba
MONGODB_ATLAS_URI=mongodb+srv://username:password@cluster.mongodb.net/bomba
```

3. **ุดุบู ุงูุชุทุจูู:**
```bash
npm run dev
```

4. **ุชุญูู ูู ุงูููุฌุงุช:**
```
โ Local MongoDB Connected Successfully!
โ MongoDB Atlas Connected Successfully! (Backup)
๐ Initializing sync system...
โ Sync middleware applied to 16/16 models
๐ Sync worker started
โ Sync system initialized successfully
```

---

## ๐ API Endpoints

### ูุฑุงูุจุฉ ุงููุธุงู

```bash
# ูุญุต ุงูุตุญุฉ (ุนุงู - ุจุฏูู authentication)
GET /api/sync/health

# ุงูุฅุญุตุงุฆูุงุช (Admin ููุท)
GET /api/sync/metrics

# ุชูุฑูุฑ ููุตู (Admin ููุท)
GET /api/sync/report

# ุญุงูุฉ ุงููุงุฆูุฉ (Admin ููุท)
GET /api/sync/queue

# ุญุงูุฉ ุงูู Worker (Admin ููุท)
GET /api/sync/worker

# ุญุงูุฉ ุงูุงุชุตุงูุงุช (Admin ููุท)
GET /api/sync/connections

# ุงูุฅุนุฏุงุฏุงุช (Admin ููุท)
GET /api/sync/config
```

### ุงูุชุญูู ุจุงููุธุงู

```bash
# ุงูุชุญูู ุจุงูู Worker (Admin ููุท)
POST /api/sync/worker/control
Body: { "action": "start|stop|pause|resume" }

# ูุณุญ ุงููุงุฆูุฉ (Admin ููุท)
POST /api/sync/queue/clear

# ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุญุตุงุฆูุงุช (Admin ููุท)
POST /api/sync/stats/reset
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช

### ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุฑุฆูุณูุฉ

```env
# ุชูุนูู/ุชุนุทูู ุงููุฒุงููุฉ
SYNC_ENABLED=true

# ุงุชุตุงูุงุช ููุงุนุฏ ุงูุจูุงูุงุช
MONGODB_LOCAL_URI=mongodb://localhost:27017/bomba
MONGODB_ATLAS_URI=mongodb+srv://...

# ุฅุนุฏุงุฏุงุช ุงููุงุฆูุฉ
SYNC_QUEUE_MAX_SIZE=10000
SYNC_WORKER_INTERVAL=100

# ุฅุนุฏุงุฏุงุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ
SYNC_MAX_RETRIES=5

# ุงูุญูุธ ุนูู ุงููุฑุต
SYNC_PERSIST_QUEUE=true
SYNC_QUEUE_PATH=./data/sync-queue.json

# Collections ุงููุณุชุจุนุฏุฉ (ููุตููุฉ ุจููุงุตู)
SYNC_EXCLUDED_COLLECTIONS=

# ุญุฌู ุงูุฏูุนุฉ ูููุฒุงููุฉ ุงููุงููุฉ
SYNC_BATCH_SIZE=100
```

---

## ๐ ุงููุฑุงูุจุฉ

### ูุญุต ุงูุตุญุฉ

```bash
curl http://localhost:5000/api/sync/health
```

**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "checks": {
      "syncEnabled": { "status": "pass" },
      "localDatabase": { "status": "pass" },
      "atlasDatabase": { "status": "pass" },
      "worker": { "status": "pass" },
      "queueSize": { "status": "pass", "value": 0 },
      "syncLag": { "status": "pass" },
      "failureRate": { "status": "pass", "value": 0 }
    },
    "warnings": [],
    "errors": []
  }
}
```

### ุงูุฅุญุตุงุฆูุงุช

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:5000/api/sync/metrics
```

---

## ๐ฏ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### โ ุงูุณุฑุนุฉ
- ุฌููุน ุงูุนูููุงุช ุนูู MongoDB ูุญูู
- ูุง ุชุฃุฎูุฑ ูู ุงูุนูููุงุช ุงูุฃุณุงุณูุฉ
- ูุชูุณุท ููุช ุงูุนูููุฉ: < 5ms

### โ ุงูููุซูููุฉ
- ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู ุนูู Atlas
- Retry logic ุฐูู
- Queue persistence ุนูู ุงููุฑุต
- Graceful shutdown

### โ ุงูุดูุงููุฉ
- ูุง ุชุญุชุงุฌ ุชุนุฏูู ุงูููุฏ ุงูููุฌูุฏ
- Middleware ุชููุงุฆู ุนูู ุฌููุน ุงูููุงุฐุฌ
- ูุนูู ูุน ุฌููุน ุนูููุงุช Mongoose

### โ ุงููุฑููุฉ
- ูุนูู ุญุชู ูู ุงููุทุน Atlas
- ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ
- Queue ูุญูุธ ุงูุนูููุงุช

### โ ุงููุฑุงูุจุฉ
- Health checks ุดุงููุฉ
- ุฅุญุตุงุฆูุงุช ููุตูุฉ
- ุชุญุฐูุฑุงุช ุชููุงุฆูุฉ
- ุชูุงุฑูุฑ ูุน ุชูุตูุงุช

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุชุทุจูู ูุง ูุจุฏุฃ

**ุงูุฃุนุฑุงุถ:**
```
โ Local MongoDB connection failed!
```

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุชุดุบูู MongoDB ุงููุญูู: `mongod`
2. ุชุญูู ูู `MONGODB_LOCAL_URI` ูู .env
3. ุชุฃูุฏ ูู ุฃู ุงููููุฐ 27017 ูุชุงุญ

### ุงููุดููุฉ: ุงููุฒุงููุฉ ูุง ุชุนูู

**ุงูุฃุนุฑุงุถ:**
```
โ๏ธ Atlas unavailable, X operations queued
```

**ุงูุญู:**
1. ุชุญูู ูู `SYNC_ENABLED=true`
2. ุชุญูู ูู ุตุญุฉ `MONGODB_ATLAS_URI`
3. ุชุญูู ูู ุฅุถุงูุฉ IP ูู Atlas Network Access
4. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช

### ุงููุดููุฉ: ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุชูุจุฑ

**ุงูุฃุนุฑุงุถ:**
```
โ๏ธ Sync queue size is large: 5000/10000
```

**ุงูุญู:**
1. ุชุญูู ูู ุงุชุตุงู Atlas
2. ุฑุงุฌุน ุงูููุฌุงุช ููุฃุฎุทุงุก
3. ูุฏ ุชุญุชุงุฌ ูุฒูุงุฏุฉ `SYNC_WORKER_INTERVAL`
4. ุชุญูู ูู ุฃุฏุงุก Atlas

### ุงููุดููุฉ: ูุนุฏู ูุดู ุนุงูู

**ุงูุฃุนุฑุงุถ:**
```
โ๏ธ High sync failure rate: 15%
```

**ุงูุญู:**
1. ุฑุงุฌุน ุงูููุฌุงุช ููุฃุฎุทุงุก ุงููุญุฏุฏุฉ
2. ุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
3. ุชุญูู ูู ุฃุฏุงุก Atlas
4. ูุฏ ุชุญุชุงุฌ ูุฒูุงุฏุฉ `SYNC_MAX_RETRIES`

---

## ๐ ุงูุฃุฏุงุก

### ุงูููุงููุณ ุงููุชููุนุฉ

- **ุงูุนูููุงุช ุงููุญููุฉ:** < 5ms
- **ุงููุฒุงููุฉ:** 50-200ms (ุบูุฑ ูุชุฒุงููุฉ)
- **ุญุฌู ุงููุงุฆูุฉ:** 0-100 ูู ุงูุธุฑูู ุงูุนุงุฏูุฉ
- **ูุนุฏู ุงููุฌุงุญ:** > 99%
- **Sync lag:** < 1 ุซุงููุฉ

### ุงูุชุญุณููุงุช ุงูููููุฉ

1. **ุฒูุงุฏุฉ SYNC_WORKER_INTERVAL** ุฅุฐุง ูุงู Atlas ุจุทูุก
2. **ุงุณุชุจุนุงุฏ Collections** ุบูุฑ ูููุฉ ูู ุงููุฒุงููุฉ
3. **ุฒูุงุฏุฉ SYNC_QUEUE_MAX_SIZE** ููุฃุญูุงู ุงูุนุงููุฉ
4. **ุชุญุณูู ููุงุฑุณ Atlas** ููุนูููุงุช ุงูุฃุณุฑุน

---

## ๐ ุงูุฃูุงู

### โ ุชู ุชุทุจููู

- ุจูุงูุงุช ุงูุงุนุชูุงุฏ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุท
- ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุณุงุณุฉ ูู ุงูููุฌุงุช
- TLS/SSL ููุนู ูุงุชุตุงูุงุช Atlas
- API endpoints ูุญููุฉ ุจู authentication
- Admin ููุท ููููู ุงููุตูู ูู endpoints ุงูุชุญูู

### ๐ ุฃูุถู ุงูููุงุฑุณุงุช

1. ูุง ุชุดุงุฑู ููู `.env`
2. ุงุณุชุฎุฏู IP whitelisting ูู Atlas
3. ูู ุจุชุฏููุฑ ุจูุงูุงุช ุงูุงุนุชูุงุฏ ุจุงูุชุธุงู
4. ุฑุงูุจ ุงูููุฌุงุช ููุฃูุดุทุฉ ุงููุดุจููุฉ
5. ุงุณุชุฎุฏู HTTPS ูู ุงูุฅูุชุงุฌ

---

## ๐ ุงููููุงุช ุงููููุฉ

### ุงูุฅุนุฏุงุฏุงุช
- `server/config/syncConfig.js` - ุงูุฅุนุฏุงุฏุงุช ุงููุฑูุฒูุฉ
- `server/config/dualDatabaseManager.js` - ุฅุฏุงุฑุฉ ุงูุงุชุตุงูุงุช
- `server/config/applySync.js` - ุชุทุจูู Middleware

### ุงูุฎุฏูุงุช
- `server/services/sync/syncQueueManager.js` - ุฅุฏุงุฑุฉ ุงููุงุฆูุฉ
- `server/services/sync/syncWorker.js` - ูุนุงูุฌุฉ ุงูุนูููุงุช
- `server/services/sync/syncMonitor.js` - ุงููุฑุงูุจุฉ

### Middleware
- `server/middleware/sync/syncMiddleware.js` - Mongoose hooks

### API
- `server/routes/syncRoutes.js` - ุงููุณุงุฑุงุช
- `server/controllers/syncController.js` - ุงููุชุญููุงุช

### ุงูุชูุซูู
- `DUAL_MONGODB_SYNC_SETUP.md` - ุฏููู ุงูุฅุนุฏุงุฏ
- `server/services/sync/README.md` - ุฏููู ุงููุทูุฑ
- `.kiro/specs/dual-mongodb-sync/` - ุงูููุงุตูุงุช ุงููุงููุฉ

---

## ๐ ููู ูุนูู ุงููุธุงู

### 1. ุงูุนูููุฉ ุงููุญููุฉ
```
User Request โ Controller โ Model.save()
                                โ
                         Local MongoDB โ
                                โ
                         Return Success
```

### 2. ุงููุฒุงููุฉ (ูู ุงูุฎูููุฉ)
```
Model.save() โ Post-Save Hook โ Enqueue Operation
                                      โ
                                 Sync Queue
                                      โ
                                 Sync Worker
                                      โ
                              Execute on Atlas โ
```

### 3. ูุนุงูุฌุฉ ุงููุดู
```
Operation Fails โ Retry with Backoff
                       โ
                  Max Retries?
                  โ         โ
                Yes        No
                 โ          โ
            Log Error   Re-queue
```

---

## ๐ฆ ุงูุญุงูุงุช ุงููุฎุชููุฉ

### โ ุงูุญุงูุฉ ุงูุทุจูุนูุฉ
- Local: ูุชุตู โ
- Atlas: ูุชุตู โ
- Worker: ูุนูู โ
- Queue: ูุงุฑุบุฉ ุฃู ุตุบูุฑุฉ
- **ุงููุชูุฌุฉ:** ูุฒุงููุฉ ููุฑูุฉ

### โ๏ธ Atlas ุบูุฑ ูุชุงุญ
- Local: ูุชุตู โ
- Atlas: ุบูุฑ ูุชุตู โ
- Worker: ูุนูู โธ๏ธ
- Queue: ุชูุจุฑ ุชุฏุฑูุฌูุงู
- **ุงููุชูุฌุฉ:** ุงูุนูููุงุช ุชูุญูุธ ูู ุงููุงุฆูุฉ

### ๐ ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู
- Local: ูุชุตู โ
- Atlas: ูุชุตู ูุฌุฏุฏุงู โ
- Worker: ูุนูู โ
- Queue: ุชูุนุงูุฌ ุชุฏุฑูุฌูุงู
- **ุงููุชูุฌุฉ:** ูุฒุงููุฉ ุฌููุน ุงูุนูููุงุช ุงููุนููุฉ

---

## ๐ ุงูุฏุนู

### ุงูููุงุฑุฏ
- ุงูููุงุตูุงุช: `.kiro/specs/dual-mongodb-sync/`
- ุฏููู ุงูุฅุนุฏุงุฏ: `DUAL_MONGODB_SYNC_SETUP.md`
- ุฏููู ุงููุทูุฑ: `server/services/sync/README.md`

### ุงูููุฌุงุช
- ุฌููุน ุนูููุงุช ุงููุฒุงููุฉ ูุณุฌูุฉ
- ุงุณุชุฎุฏู `syncMonitor.logStatus()` ููุญุงูุฉ ุงูุญุงููุฉ
- ุฑุงุฌุน `server/logs/` ููุชูุงุตูู

### API ูููุฑุงูุจุฉ
```bash
# ุงูุญุงูุฉ ุงูุณุฑูุนุฉ
GET /api/sync/health

# ุงูุชูุงุตูู ุงููุงููุฉ
GET /api/sync/report
```

---

## โจ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ูุธุงู ูุฒุงููุฉ ูุฒุฏูุฌ ูุชูุฏู ูุฌูุน ุจูู:
- **ุงูุณุฑุนุฉ:** ุนูููุงุช ูุญููุฉ ููุฑูุฉ
- **ุงูููุซูููุฉ:** ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู
- **ุงููุฑููุฉ:** ูุนูู ูู ุฌููุน ุงูุธุฑูู
- **ุงูุดูุงููุฉ:** ุจุฏูู ุชุนุฏูู ุงูููุฏ
- **ุงููุฑุงูุจุฉ:** ุฅุญุตุงุฆูุงุช ูุชุญุฐูุฑุงุช ุดุงููุฉ

ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌ ููุนูู ุจููุงุกุฉ ุนุงููุฉ! ๐


---

## ๐ ุฏููู ุงูุชุฑุญูู ูุงููุดุฑ

ููุญุตูู ุนูู ุชุนูููุงุช ููุตูุฉ ุญูู ุชุฑุญูู ุงููุธุงู ุฅูู ุงูุฅูุชุงุฌ:

### ุฏููู ุงูุชุฑุญูู ุงููุงูู
- **ุงููููุน**: `server/docs/MIGRATION_GUIDE.md`
- **ุงููุญุชูู**: 
  - ุฎุทูุงุช ุงูุชุฑุญูู ุนูู 3 ูุฑุงุญู
  - ุฅุฌุฑุงุกุงุช ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ
  - ุฎุทุท ุงูุงุณุชุฑุฌุงุน (Rollback)
  - ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ูุฅุตูุงุญูุง

### ูุงุฆูุฉ ุงูุชุญูู ูู ุงููุดุฑ
- **ุงููููุน**: `server/docs/DEPLOYMENT_CHECKLIST.md`
- **ุงููุญุชูู**:
  - ูุงุฆูุฉ ุชุญูู ุดุงููุฉ ููู ูุฑุญูุฉ
  - ูุชุทูุจุงุช ุงููุธุงู
  - ุฎุทูุงุช ุงูุชุญูู
  - ูุนุงููุฑ ุงููุฌุงุญ

### ูุฑุฌุน ุณุฑูุน ูููุดุฑ
- **ุงููููุน**: `DEPLOYMENT_QUICK_REFERENCE.md`
- **ุงููุญุชูู**:
  - ุฃูุงูุฑ ุณุฑูุนุฉ ูููุดุฑ
  - ูุคุดุฑุงุช ุงูุตุญุฉ
  - ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ุงูุณุฑูุน
  - ุฅุฌุฑุงุกุงุช ุงูุทูุงุฑุฆ

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ููุจูุฆุฉ ุงูุฌุฏูุฏุฉ**: ุงุชุจุน `QUICK_START_SYNC.md`
2. **ููุชุฑุญูู ุฅูู ุงูุฅูุชุงุฌ**: ุงุชุจุน `server/docs/MIGRATION_GUIDE.md`
3. **ูููุฑุงูุจุฉ ุงูููููุฉ**: ุงุณุชุฎุฏู API endpoints
4. **ูููุดุงูู**: ุฑุงุฌุน ูุณู ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ูู ุฏููู ุงูุชุฑุญูู

---

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐**
