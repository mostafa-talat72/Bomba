# ููุฎุต ุชุฑุญูู ูุฑุงุฌุน ุงูุทุงููุงุช (Table Reference Migration)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ุณูุฑูุจุช migration ุดุงูู ูุชุญููู ุงููุธุงู ูู ุงุณุชุฎุฏุงู `tableNumber` (string/number) ุฅูู `table` (ObjectId reference).

## ๐ฏ ุงููุฏู

ุชุญููู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุณุชุฎุฏุงู ูุฑุงุฌุน ุตุญูุญุฉ (ObjectId) ุจุฏูุงู ูู ุงูููู ุงููุจุงุดุฑุฉ.

## ๐ ุงููููุงุช ุงููููุดุฃุฉ

### 1. ุณูุฑูุจุช ุงูุชุฑุญูู
**ุงูููู:** `server/scripts/migrateTableReferences.js`

**ุงููุธุงุฆู:**
- โ ุชุฑุญูู ุงูููุงุชูุฑ (Bills) ูู `tableNumber` ุฅูู `table`
- โ ุชุฑุญูู ุงูุทูุจุงุช (Orders) ูู `tableNumber` ุฅูู `table`
- โ ูุทุงุจูุฉ ุงูุทุงููุงุช ุจูุงุกู ุนูู ุงูุฑูู ูุงููุคุณุณุฉ
- โ ุฅูุดุงุก ุชูุฑูุฑ ููุตู ุจุงููุชุงุฆุฌ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุขูู

**ุงููููุฒุงุช:**
- ๐ ุขูู ููููู ุชุดุบููู ุนุฏุฉ ูุฑุงุช (idempotent)
- ๐ข ูุนูู ุนูู ูุณุชูู ุงููุคุณุณุฉ (organization-aware)
- ๐ ุชูุฑูุฑ ููุตู ุจุงููุชุงุฆุฌ
- โ๏ธ ูุณุฌู ุงูุจูุงูุงุช ุบูุฑ ุงููุทุงุจูุฉ ูููุนุงูุฌุฉ ุงููุฏููุฉ

### 2. ุฏููู ุงูุชุฑุญูู ุงูุดุงูู
**ุงูููู:** `TABLE_MIGRATION_GUIDE.md`

**ุงููุญุชูู:**
- ุดุฑุญ ุงููุดููุฉ ูุงูุญู
- ุฎุทูุงุช ุงูุชุฑุญูู ุงูุชูุตูููุฉ
- ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุบูุฑ ุงููุทุงุจูุฉ
- ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุฑุญูู
- ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ

### 3. ุฏููู ุณุฑูุน ุจุงูุนุฑุจู
**ุงูููู:** `MIGRATION_STEPS_AR.md`

**ุงููุญุชูู:**
- ุฎุทูุงุช ุณุฑูุนุฉ ููุฎุชุตุฑุฉ
- ุฃูุซูุฉ ุนูููุฉ
- ุญููู ูููุดุงูู ุงูุดุงุฆุนุฉ

### 4. ุชูุซูู ุชููู ููุณูุฑูุจุช
**ุงูููู:** `server/scripts/README_MIGRATION.md`

**ุงููุญุชูู:**
- ุดุฑุญ ุชููู ููุตู
- ุฎูุงุฑุฒููุฉ ุงููุทุงุจูุฉ
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- ุงุฎุชุจุงุฑ ูุงูุชุญูู

### 5. ุชุญุฏูุซ package.json
**ุงูุฃูุฑ ุงูุฌุฏูุฏ:** `npm run migrate:tables`

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุฎุทูุฉ 1: ุงููุณุฎ ุงูุงุญุชูุงุทู
```bash
mongodump --uri="mongodb://localhost:27017/bomba" --out=./backup-$(date +%Y%m%d)
```

### ุงูุฎุทูุฉ 2: ุชุดุบูู ุงูุณูุฑูุจุช
```bash
npm run migrate:tables
```

### ุงูุฎุทูุฉ 3: ูุฑุงุฌุนุฉ ุงูุชูุฑูุฑ
ุฑุงุฌุน ุงูุชูุฑูุฑ ุงููุทุจูุน ูุชุฃูุฏ ูู:
- โ ุนุฏุฏ ุงูุณุฌูุงุช ุงูููุฑุญููุฉ ุจูุฌุงุญ
- โ๏ธ ุงูุณุฌูุงุช ุบูุฑ ุงููุทุงุจูุฉ (ุฅู ูุฌุฏุช)
- โ ุงูุฃุฎุทุงุก (ุฅู ูุฌุฏุช)

### ุงูุฎุทูุฉ 4: ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุบูุฑ ุงููุทุงุจูุฉ
ุฅุฐุง ูุงู ููุงู ุณุฌูุงุช ุบูุฑ ูุทุงุจูุฉ:
1. ุฃุถู ุงูุทุงููุงุช ุงูููููุฏุฉ
2. ุฃู ุนููู ุทุงููุฉ ุงูุชุฑุงุถูุฉ
3. ุฃู ุงุญุฐู ุงูุญูู ููุจูุงูุงุช ุงููุฏููุฉ

### ุงูุฎุทูุฉ 5: ุฅุนุงุฏุฉ ุงูุชุดุบูู (ุฅุฐุง ูุฒู)
```bash
npm run migrate:tables
```

## ๐ ูุซุงู ุนูู ุงูุชูุฑูุฑ

```
============================================================
๐ MIGRATION REPORT
============================================================

๐ Bills:
   Total: 150
   โ Matched & Updated: 145
   โ๏ธ  Not Matched: 5
   โ Errors: 0

๐ฆ Orders:
   Total: 320
   โ Matched & Updated: 315
   โ๏ธ  Not Matched: 5
   โ Errors: 0

๐ Summary:
   Total Documents: 470
   Successfully Migrated: 460
   Not Matched: 10
   Errors: 0

โ๏ธ  Bills with no matching table:
   - Bill: BILL-2411201234567890, tableNumber: "A1", org: 507f...
   
โ๏ธ  Orders with no matching table:
   - Order: ORD-2411201234567892, tableNumber: "A1", org: 507f...
============================================================
```

## ๐ ูุง ููุนูู ุงูุณูุฑูุจุช

### ููููุงุชูุฑ (Bills):
```javascript
// ูุจู
{
  _id: ObjectId("..."),
  tableNumber: "A1",  // string or number
  organization: ObjectId("..."),
  // ... other fields
}

// ุจุนุฏ
{
  _id: ObjectId("..."),
  table: ObjectId("table_id"),  // reference to Table
  organization: ObjectId("..."),
  // ... other fields
  // tableNumber removed
}
```

### ููุทูุจุงุช (Orders):
ููุณ ุงูุนูููุฉ.

## โ ุงูุชุญูู ูู ุงููุฌุงุญ

### ูู MongoDB Shell:
```javascript
// ูุฌุจ ุฃู ูููู 0
db.bills.countDocuments({ tableNumber: { $exists: true } })
db.orders.countDocuments({ tableNumber: { $exists: true } })

// ูุฌุจ ุฃู ูุณุงูู ุนุฏุฏ ุงูุณุฌูุงุช ุงูููุฑุญููุฉ
db.bills.countDocuments({ table: { $exists: true } })
db.orders.countDocuments({ table: { $exists: true } })
```

### ูู ุงูุชุทุจูู:
- โ ุนุฑุถ ุงูููุงุชูุฑ ูุงูุทูุจุงุช
- โ ุฅูุดุงุก ููุงุชูุฑ ูุทูุจุงุช ุฌุฏูุฏุฉ
- โ ุงูุชูุงุฑูุฑ ุชุนูู ุจุดูู ุตุญูุญ

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ูุฌุงุญ ุงูุชุฑุญููุ ูุฌุจ ุชุญุฏูุซ ุงูููุฏ:

### 1. ุชุญุฏูุซ Models
```javascript
// Bill.js & Order.js
table: {
    type: mongoose.Schema.Types.ObjectId,
    ref: "Table",
    default: null
}
// Remove tableNumber field
```

### 2. ุชุญุฏูุซ Controllers
```javascript
// Populate table reference
.populate('table')

// Use table._id instead of tableNumber
```

### 3. ุชุญุฏูุซ Frontend
```typescript
// Use table object instead of tableNumber
interface Bill {
  table?: {
    _id: string;
    number: string | number;
    section: Section;
  };
}
```

### 4. ุชุญุฏูุซ API Endpoints
```javascript
// Accept table ObjectId instead of tableNumber
{ table: tableId }
```

### 5. ุญุฐู ุงูููุฏ ุงููุฏูู
- ุญุฐู ูู ุงููุฑุงุฌุน ูู `tableNumber`
- ุชุญุฏูุซ ุงูู validation
- ุชุญุฏูุซ ุงูู indexes

## ๐ก๏ธ ุงูุฃูุงู

### ุงููุณุฎ ุงูุงุญุชูุงุทู
```bash
# ูุจู ุงูุชุฑุญูู
mongodump --uri="mongodb://localhost:27017/bomba" --out=./backup-before-migration

# ุงูุงุณุชุนุงุฏุฉ (ุฅุฐุง ูุฒู)
mongorestore --uri="mongodb://localhost:27017/bomba" --drop ./backup-before-migration/bomba
```

### ุงูุณูุฑูุจุช ุขูู
- โ ูุง ูุญุฐู ุฃู ุจูุงูุงุช
- โ ูููู ุชุดุบููู ุนุฏุฉ ูุฑุงุช
- โ ูุนูู ุนูู ูุณุชูู ุงููุคุณุณุฉ
- โ ูุชุนุงูู ูุน ุงูุทุงููุงุช ุงููุดุทุฉ ููุท

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ูุจู ุงูุชุดุบูู:**
   - โ ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ
   - โ ุงูุชุฃูุฏ ูู ุตุญุฉ ุจูุงูุงุช ุงูุทุงููุงุช
   - โ ุงูุชุฃูุฏ ูู ุฃู MongoDB ูุนูู

2. **ุฃุซูุงุก ุงูุชุดุบูู:**
   - โณ ูุฏ ูุณุชุบุฑู ููุชุงู ุญุณุจ ุญุฌู ุงูุจูุงูุงุช
   - ๐ ุฑุงูุจ ุงูุชูุฑูุฑ ุงููุทุจูุน
   - โ๏ธ ูุง ุชูุงุทุน ุงูุนูููุฉ

3. **ุจุนุฏ ุงูุชุดุบูู:**
   - โ ุฑุงุฌุน ุงูุชูุฑูุฑ
   - โ ุชุญูู ูู ุงูุจูุงูุงุช
   - โ ุงุฎุชุจุฑ ุงูุชุทุจูู

## ๐ ุญู ุงููุดุงูู

### ุงูุณูุฑูุจุช ูุง ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุญูู ูู ุฃู MongoDB ูุนูู
- ุฑุงุฌุน `MONGODB_URI` ูู `.env`
- ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ

### ุณุฌูุงุช ูุซูุฑุฉ ุบูุฑ ูุทุงุจูุฉ
- ุชุญูู ูู ุจูุงูุงุช ุงูุทุงููุงุช
- ุชุฃูุฏ ูู ุชุทุงุจู organization IDs
- ุชุฃูุฏ ูู ุฃู ุงูุทุงููุงุช ูุดุทุฉ

### ุงูุณูุฑูุจุช ูุชููู
- ุชุญูู ูู ุงุชุตุงู MongoDB
- ุฑุงุฌุน ููุงุฑุฏ ุงููุธุงู
- ุชุญูู ูู logs

## ๐ ุงููุฑุงุฌุน

- **ุงูุฏููู ุงูุดุงูู:** `TABLE_MIGRATION_GUIDE.md`
- **ุงูุฏููู ุงูุณุฑูุน:** `MIGRATION_STEPS_AR.md`
- **ุงูุชูุซูู ุงูุชููู:** `server/scripts/README_MIGRATION.md`
- **ุงูุณูุฑูุจุช:** `server/scripts/migrateTableReferences.js`

## โจ ุงูุฎูุงุตุฉ

ุชู ุฅูุดุงุก ูุธุงู ุชุฑุญูู ุดุงูู ูุขูู ูุญูู ุงูุจูุงูุงุช ูู `tableNumber` ุฅูู `table` ObjectId references. ุงูุณูุฑูุจุช ุฌุงูุฒ ููุงุณุชุฎุฏุงู ููููุซูู ุจุงููุงูู.

**ุงูุฃูุฑ:** `npm run migrate:tables`

**ุงููุชูุฌุฉ:** ุจูุงูุงุช ูุธููุฉ ูููุธูุฉ ูุน referential integrity ูุงููุฉ! ๐
